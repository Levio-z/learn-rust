---
tags:
  - permanent
---
## 1. 核心观点  

[[# 架构设计的本质目的是为了解决软件系统的复杂性]]，所以在我们设计架构时，首先就要分析系统的复杂性。


[[# 架构设计对于复杂性的具体判断]]
- **复杂度只是少数部分，即使三个方面都有问题，也必须要进行优先级排序**
	- 大部分复杂度只是其中的某一个
	- 少数情况下包含其中两个
	- 三个或者三个以上的复杂度
		- 假的，这个系统之前设计的有问题，要么可能就是架构师的判断出现了失误
		- 真的，**要进行优先级排序**
[[#接手了一个每个复杂度都存在问题的系统，那应该怎么办呢？]]
- 答案是**一个个来解决问题，不要幻想一次架构重构解决所有问题**。
- 正确的做法是将主要的复杂度问题**列出来**，然后根据业务、技术、团队等综合情况进行排序，**优先解决当前面临的最主要的复杂度问题**。
	- 实际案例
		- 优化子系统数量->开发效率->这两方便提高了系统稳定性->最后引入异地多活

[[# 如果按照优先级来解决复杂度，可能会出现解决了优先级排在前面的复杂度后，解决后续复杂度的方案需要将已经落地的方案推倒重来？]]
- 不重来，这个担忧**理论上是可能的，但现实中几乎是不可能出现的，原因在于软件系统的可塑性和易变性**。
- 推倒重来，这个新的方案也必须能够同时解决已经被解决的复杂度问题，一般来说能够达到这种理想状态的方案基本都是依靠新技术的引入。
## 2. 背景/出处  
- 来源：
- 引文/摘要：  
  - …  
  - …  

## 3. 展开说明  

### 案例
我们假想一个创业公司，名称叫作“前浪微博”​。前浪微博的业务发展很快，系统也越来越多，系统间协作的效率很低，例如：用户发一条微博后，微博子系统需要通知审核子系统进行审核，然后通知统计子系统进行统计，再通知广告子系统进行广告预测，接着通知消息子系统进行消息推送……一条微博有十几个通知，目前都是系统间通过接口调用的。每通知一个新系统，微博子系统就要设计接口、进行测试，效率很低，问题定位很麻烦，经常和其他子系统的技术人员产生分岐，微博子系统的开发人员不胜其烦。用户等级达到VIP后，等级子系统要通知福利子系统进行奖品发放，要通知客服子系统安排专属服务人员，要通知商品子系统进行商品打折处理……等级子系统的开发人员也是不胜其烦。新来的架构师在梳理这些问题时，结合自己的经验，敏锐地发现了这些问题背后的根源在于架构上各业务子系统强耦合，而消息队列系统正好可以完成子系统的解耦，于是提议要引入消息队列系统。经过一分析二讨论三开会四汇报五审批等一系列操作后，消息队列系统终于立项了。

其他背景信息还有：
中间件团队规模不大，大约6人左右。
中间件团队熟悉Java语言，但有一个新同事C/C++很牛。
开发平台是Linux，数据库是MySQL。
目前整个业务系统是单机房部署，没有双机房。
##### 这个消息队列是否需要高性能
我们假设前浪微博系统用户每天发送1000万条微博，那么微博子系统一天会产生1000万条消息，我们再假设平均一条消息有10个子系统读取，那么其他子系统读取的消息大约是1亿次。

1000万和1亿看起来很吓人，但对于架构师来说，关注的不是一天的数据，而是1秒的数据，即TPS和QPS。我们将数据按照秒来计算，
**一天内平均每秒写入消息数为115条，每秒读取的消息数是1150条**；
再考虑系统的读写并不是完全平均的，设计的目标应该以峰值来计算。峰值一般取平均值的3倍，那么消息队列系统的**TPS是345，QPS是3450**，这个量级的数据意味着并不要求高性能。

虽然根据当前业务规模计算的性能要求并不高，但业务会增长，因此系统设计需要考虑一定的性能余量。由于现在的基数较低，为了预留一定的系统容量应对后续业务的发展，**我们将设计目标设定为峰值的4倍，因此最终的性能要求是：TPS为1380，QPS为13800**。TPS为1380并不高，但QPS为13800已经比较高了，因此高性能读取是复杂度之一。注意，这里的**设计目标设定为峰值的4倍是根据业务发展速度来预估的，不是固定为4倍，不同的业务可以是2倍，也可以是8倍，但一般不要设定在10倍以上，更不要一上来就按照100倍预估**。

##### 这个消息队列是否需要高可用性


对于微博子系统来说，如果消息丢了，导致没有审核，然后触犯了国家法律法规，则是非常严重的事情；对于等级子系统来说，如果用户达到相应等级后，系统没有给他奖品和专属服务，则VIP用户会很不满意，导致用户流失从而损失收入，虽然也比较关键，但没有审核子系统丢消息那么严重。
综合来看，消息队列需要高可用性，包括**消息写入、消息存储、消息读取都需要保证高可用性**。

#### 这个消息队列是否需要高可扩展性
消息队列的功能很明确，基本无须扩展，因此可扩展性不是这个消息队列的复杂度关键。


#### 总结

综合分析下来，消息队列的复杂性主要体现在这几个方面：高性能消息读取、高可用消息写入、高可用消息存储、高可用消息读取。

## 4. 与其他卡片的关联  
- 前置卡片：
- 后续卡片：
- 相似主题：

## 5. 应用/启发  
- 可以如何应用在工作、学习、生活中  
- 引发的思考与问题  

## 6. 待办/进一步探索  
- [ ] 深入阅读 xxx  
- [ ] 验证这个观点的边界条件  
