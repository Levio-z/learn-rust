---
tags:
  - permanent
---

## 1. 核心观点  
### CAP 理论的严格适用前提
#### “跨节点一致性问题”
CAP 并不是对所有“分布式系统”都成立，而是隐含了以下前提条件：
1. **系统由多个节点组成（分布式）**
2. **多个节点共同对外提供同一份逻辑数据**
3. **这些数据存在副本（replica），需要一致性语义**
4. **节点之间通过不可靠网络通信（可能分区）**
#### 关注读写操作
CAP关注的是对数据的读写操作，而不是分布式系统的所有功能
### 定义
在一个分布式系统（指互相连接并共享数据的节点的集合）中，当涉及读写操作时，只能保证一致性（Consistence）​、可用性（Availability）​、分区容错性（Partition Tolerance）三者中的两个，另外一个必须被牺牲。
### 一致性
对某个指定的客户端来说，读操作保证能够返回最新的写操作结果。
### 可用性
非故障的节点在合理的时间内返回合理的响应（不是错误和超时的响应）​。
### 分区容忍性
当出现网络分区后，系统能够继续“履行职责”​。
### [CAP应用](21%20架构设计-架构模式-CAP理论.md#CAP应用)
分布式系统理论上不可能选择CA架构，只能选择CP或者AP架构。因为P必然存在。P存在的前提下，CA互相不能满足。
### CP
[架构设计-CAP-CP](../../../4%20note/zk/permanent/架构设计-CAP-CP.md)

### AP
[架构设计-CAP-AP](../../../4%20note/zk/permanent/架构设计-CAP-AP.md)

### CA
[架构设计-CAP-CA-某些特定场景](../../../4%20note/zk/permanent/架构设计-CAP-CA-某些特定场景.md)
## 2. 背景/出处  
- 来源：
- 引文/摘要：  
  - …  
  - …  

## 3. 展开说明  
### 出处

CAP定理（CAP theorem）又被称作布鲁尔定理（Brewer's theorem）​，是加州大学伯克利分校的计算机科学家埃里克·布鲁尔（Eric Brewer）在2000年的ACM PODC上提出的一个猜想。2002年，麻省理工学院的赛斯·吉尔伯特（Seth Gilbert）和南希·林奇（Nancy Lynch）发表了布鲁尔猜想的证明，使之成为分布式计算领域公认的一个定理。**对于设计分布式系统的架构师来说，CAP是必须掌握的理论**。

布鲁尔在提出CAP猜想的时候，并没有详细定义Consistency、Availability、Partition Tolerance三个单词的明确定义，因此如果初学者去查询CAP定义的时候会感到比较困惑，因为不同的资料对CAP的详细定义有一些细微的差别，例如：


### CAP
第一版
对于一个分布式计算系统，不可能同时满足一致性（Consistence）​、可用性（Availability）​、分区容错性（Partition Tolerance）三个设计约束。

第二版
在一个分布式系统（指互相连接并共享数据的节点的集合）中，当涉及读写操作时，只能保证一致性（Consistence）​、可用性（Availability）​、分区容错性（Partition Tolerance）三者中的两个，另外一个必须被牺牲。



### 一致性（Consistency）

对某个指定的客户端来说，读操作保证能够返回最新的写操作结果。

>第一版:简单翻译为：所有节点在同一时刻都能看到相同的数据。

>**中间状态不可见**：第一版从节点node的角度描述，第二版从客户端client的角度描述。相比来说，**第二版更加符合我们观察和评估系统的方式，即站在客户端的角度来观察系统的行为和特征**。
>事务**执行过程中**：
    - 系统**可以处于逻辑上不一致的中间状态**
    - 数据可能只写了一部分
    - 不同节点 / 不同副本的数据可能不一致但这些中间状态：
    - **对外不可见**
    - **一旦出错会整体回滚**
    - **而第二版强调client读操作能够获取最新的写结果就没有问题，因为事务在执行过程中，client是无法读取到未提交的数据的，只有等到事务提交后，client才能读取到事务写入的数据**，而如果事务失败则会进行回滚，client也不会读取到事务中间写入的数据。


### 2.可用性（Availability）


第二版：非故障的节点在**合理的时间**内返回**合理的响应**（不是错误和超时的响应）​。

>第一版：简单翻译为：每个请求都能得到成功或者失败的响应。

第二版的解释明确了不能超时、不能出错，结果是合理的，注意没有说“正确”的结果。例如，应该返回100但实际上返回了90，肯定是不正确的结果，但可以是一个合理的结果。


### 3.分区容忍性（Partition Tolerance）


第二版：**当出现网络分区后，系统能够继续“履行职责”​。**
- 只有返回reasonable response才是function

>第一版：出现消息丢失或者分区错误时系统能够继续运行。

>**运行和履行职责的区别**：work强调“运行”​，只要系统不宕机，我们都可以说系统在work，返回错误也是work，拒绝服务也是work；而function强调“发挥作用”​“履行职责”​，这点和可用性是一脉相承的。也就是说，只有返回reasonable response才是function。相比之下，第二版解释更加明确。


>**分区**：对比两版解释，第一版是直接说原因，即message loss造成了分区，但message loss的定义有点狭隘，因为通常我们说的message loss（丢包）​，只是网络故障中的一种；第二版直接说现象，即发生了分区现象，不管是什么原因，可能是丢包，也可能是连接中断，还可能是拥塞，只要导致了网络分区，就通通算在里面。

### CAP应用

虽然CAP理论定义是三个要素中只能取两个，但放到分布式环境下来思考，我们会发现必须选择P（分区容忍）要素，因为网络本身无法做到100%可靠，有可能出故障，所以分区是一个必然的现象。如果我们选择了CA而放弃了P，那么当发生分区现象时，为了保证C，系统需要禁止写入，当有写入请求时，系统返回error（例如，当前系统不允许写入）​，这又和A冲突了，因为A要求返回no error和no timeout。因此，分布式系统理论上不可能选择CA架构，只能选择CP或者AP架构。





## 4. 与其他卡片的关联  
- 前置卡片：
- 后续卡片：
	- [22 架构设计-架构模式-CAP细节](22%20架构设计-架构模式-CAP细节.md)
- 相似主题：

## 5. 应用/启发  
- 可以如何应用在工作、学习、生活中  
- 引发的思考与问题  

## 6. 待办/进一步探索  
- [ ] 原子笔记拆分
	- [ ] 
- [ ] 验证这个观点的边界条件  
