## 1. 核心观点  

- [CAP关注的粒度是数据，而不是整个系统](#CAP关注的粒度是数据，而不是整个系统)
	- **每个系统不可能只处理一种数据，而是包含多种类型的数据，有的数据必须选择CP，有的数据必须选择AP**。
	- 实践：**将系统内的数据按照不同的应用场景和要求进行分类，每类数据选择不同的策略（CP还是AP）​，而不是直接限定整个系统所有数据都是同一策略**。
- [CAP是忽略网络延迟的，网路不分区这个C不可能完美存在的](#CAP是忽略网络延迟的，网路不分区这个C不可能完美存在的)
	- 完美的CP也不存在
- [架构设计-CAP-CA-某些特定场景](../../../4%20note/zk/permanent/架构设计-CAP-CA-某些特定场景.md)
- [系统分区情况下的决策是CP还是AP，也要考虑分区没有发生时如何恢复CA](#系统分区情况下的决策是CP还是AP，也要考虑分区没有发生时如何恢复CA)
- [BASE理论是AP的补充](21%20架构设计-架构模式-CAP细节.md#BASE理论是AP的补充)

## 2. 背景/出处  
- 来源：
- 引文/摘要：  
  - …  
  - …  

## 3. 展开说明  

理论的优点在于清晰简洁、易于理解，但缺点就是高度抽象化，省略了很多细节，导致在将理论应用到实践时，由于各种复杂情况，可能出现误解和偏差。如果我们没有意识到这些关键的细节点，那么在实践中应用CAP理论时，就可能发现方案很难落地。

### CAP关键细节点

### **CAP关注的粒度是数据，而不是整个系统**
**每个系统不可能只处理一种数据，而是包含多种类型的数据，有的数据必须选择CP，有的数据必须选择AP**。

C与A之间的取舍可以在同一系统内以非常细小的粒度反复发生，而每一次的决策可能因为具体的操作，乃至因为牵涉到特定的数据或用户而有所不同。

>但这句话是理解和应用CAP理论非常关键的一点。CAP理论的定义和解释中，用的都是system、node这类系统级的概念，这就给很多人造成了很大的误导，认为我们在进行架构设计时，整个系统要么选择CP，要么选择AP。但在实际设计过程中，**每个系统不可能只处理一种数据，而是包含多种类型的数据，有的数据必须选择CP，有的数据必须选择AP**。而如果我们做设计时，从整个系统的角度去选择CP还是AP，就会发现顾此失彼，无论怎么做都是有问题的。
>**具体案例**
>以一个最简单的用户管理系统为例，用户管理系统包含用户账号数据（用户ID、密码）​、用户信息数据（昵称、兴趣、爱好、性别、自我介绍等）​。通常情况下，用户账号数据会选择CP，而用户信息数据会选择AP，如果限定整个系统为CP，则不符合用户信息数据的应用场景；如果限定整个系统为AP，则又不符合用户账号数据的应用场景。

### CAP是忽略网络延迟的，网路不分区这个C不可能完美存在的

这是一个非常隐含的假设，布鲁尔在定义一致性时，并没有将延迟考虑进去。也就是说，**当事务提交时，数据能够瞬间复制到所有节点。但实际情况下，从节点A复制数据到节点B，总是需要花费一定时间的**。如果是相同机房，耗费时间可能是几毫秒；如果是跨地域的机房，例如北京机房同步到广州机房，耗费的时间就可能是几十毫秒。这就意味着，CAP理论中的C在实践中是不可能完美实现的，在数据复制的过程中，节点A和节点B的数据并不一致。
导致完整的[架构设计-CAP-CP](../../../4%20note/zk/permanent/架构设计-CAP-CP.md)是不存在的

### 系统分区情况下的决策是CP还是AP，也要考虑分区没有发生时如何恢复CA

CAP理论告诉我们分布式系统只能选择CP或者AP，但其实这里的前提是系统发生了“分区”现象。如果系统没有发生分区现象，也就是说P不存在的时候（节点间的网络连接一切正常）​，我们没有必要放弃C或者A，应该C和A都可以保证，这就要求架构设计的时候既要考虑分区发生时选择CP还是AP，也要考虑分区没有发生时如何保证CA。

CAP理论告诉我们三者只能取两个，需要“牺牲”​（sacrificed）另外一个，这里的“牺牲”是有一定误导作用的，因为“牺牲”让很多人理解成什么都不做。实际上，CAP理论的“牺牲”只是说在分区过程中我们无法保证C或者A，但并不意味着什么都不做。因为在系统整个运行周期中，大部分时间都是正常的，发生分区现象的时间并不长。例如，99.99%可用性（俗称4个9）的系统，一年运行下来，不可用的时间只有50分钟；99.999%（俗称5个9）可用性的系统，一年运行下来，不可用的时间只有5分钟。分区期间放弃C或者A，并不意味着永远放弃C和A，我们可以在分区期间进行一些操作，从而让分区故障解决后，系统能够重新达到CA的状态。

**最典型的就是在分区期间记录一些日志，当分区故障解决后，系统根据日志进行数据恢复，使得重新达到CA状态**。

- [架构设计-CAP-AP](../../../4%20note/zk/permanent/架构设计-CAP-AP.md)
- [架构设计-CAP-CP](../../../4%20note/zk/permanent/架构设计-CAP-CP.md)


### BASE理论是AP的补充
[架构设计-BASE理论](../../../4%20note/zk/permanent/架构设计-BASE理论.md)
BASE理论本质上是对CAP的延伸和补充，更具体地说，**是对CAP中AP方案的一个补充**。
AP方案中牺牲一致性只是指分区期间，而不是永远放弃一致性。
这一点其实就是BASE理论延伸的地方，分区期间牺牲一致性，但分区故障恢复后，系统应该达到最终一致性。



## 4. 与其他卡片的关联  
- 前置卡片：
- 后续卡片：
- 相似主题：

## 5. 应用/启发  
- 可以如何应用在工作、学习、生活中  
- 引发的思考与问题  

## 6. 待办/进一步探索  
- [ ] 原子笔记拆分
	- [ ] 
- [ ] 验证这个观点的边界条件  
