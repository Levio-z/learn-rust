## ✅ 一、定义：什么是 Digest？

> **Digest 是镜像内容的唯一加密校验值（哈希值），用于唯一标识镜像内容。**

它是一个 SHA256 哈希，例如：

```makefile
sha256:2f1c04d3f...2ae91a90df7
```

这个值**是根据镜像内容计算出来的，镜像内容变则 Digest 变**，即使 `REPOSITORY:TAG` 没有变。

---

## 🧠 二、Digest 的主要作用

| 作用 | 说明 |
| --- | --- |
| ✅ 唯一标识镜像内容 | Digest 是镜像内容的“指纹”，比 tag 更精确可靠。 |
| ✅ 保证镜像不可变性 | Digest 确保镜像一经发布不可篡改，拉取到的一定是相同内容。 |
| ✅ 安全拉取镜像 | 可防止镜像仓库被污染或镜像内容被悄悄替换。 |
| ✅ 精确部署 | 在 CI/CD、生产环境中，使用 digest 可保证部署的一致性。 |

---

## 🧩 三、Digest 与 Tag 的对比

| 特性 | Tag（标签） | Digest（摘要） |
| --- | --- | --- |
| 是否可变 | ✅ 可以被重写 | ❌ 不可变 |
| 直观性 | ✅ 人类可读（如 `:latest`） | ❌ 哈希值，不可读 |
| 精确性 | ❌ 相同 tag 可指向不同内容 | ✅ 唯一对应镜像内容 |
| 推荐使用场景 | 开发调试、标签管理 | 生产部署、安全控制 |

🔍 **结论**：`tag` 更像是指针，而 `digest` 是唯一身份证。

---

## 🧪 四、如何查看 Digest？

```bash
docker image ls --digests
```

示例输出：

```nginx
REPOSITORY    TAG     DIGEST                                                                    IMAGE ID       SIZE
nginx         latest  sha256:2f1c04d3f5c3048c745...2ae91a90df7    62d49f9bab67   133MB
```

也可以用 `docker pull` 拉取某个 digest：

```bash
docker pull nginx@sha256:2f1c04d3f5c3048c745...2ae91a90df7
```

---

## 🛠️ 五、典型使用场景

### ✅ 1. 锁定镜像版本（CI/CD）

```yaml
image: "nginx@sha256:2f1c04d3f..."
```

保证构建使用相同镜像版本，避免 `:latest` 随时间变动导致部署不一致。

---

### ✅ 2. 提高镜像安全性（验证镜像内容）

部署前校验镜像摘要是否与信任来源一致，防止内容被污染或供应链攻击。

---

### ✅ 3. 快速判断镜像是否变更

digest 是内容哈希，变更则 digest 变，可用于构建缓存策略、镜像更新检测。

---

## 🔬 六、Digest 是怎么计算出来的？

Digest 是 Docker Registry v2 使用的 **内容寻址机制（content-addressable storage）**：

-   对镜像 manifest 文件进行 SHA256 哈希计算
    
-   镜像的每一层（layer）也都有自己的 digest
    
-   所有层的组合最终确定镜像整体的 digest
    

这类似 Git 的提交哈希，保证内容不可伪造且可以重现。

---

## 🧱 七、相关扩展知识点

| 概念 | 说明 |
| --- | --- |
| `docker pull nginx@sha256:...` | 直接通过 digest 拉取指定镜像版本 |
| `docker inspect` | 可查看 digest 对应的镜像元数据 |
| OCI 镜像规范 | digest 是 Open Container Initiative 的一部分 |
| 镜像签名（Notary / cosign） | digest 是镜像签名的基础数据（防篡改保障） |

---

## ✅ 总结

Digest 是镜像不可变性和安全性的保障，是比 tag 更底层、更可靠的标识手段。在现代 DevOps 流程中：

-   **开发阶段：** 用 tag 快速识别
    
-   **测试 / 生产阶段：** 用 digest 锁定精确镜像版本
    

---