---
tags:
  - note
---
## 1. 核心观点  

能用一个命令（进程）完成的任务，就不要拆分成多个命令（进程）通过管道连接，以减少不必要的子进程创建和进程间通信（IPC）开销。

在 shell 里通过「`|`」匿名管道将多个命令连接在一起，实际上也就是创建了多个子进程，那么在我们编写 shell 脚本时，能使用一个管道搞定的事情，就不要多用一个管道，这样可以减少创建子进程的系统开销。开销主要来自于**创建**和**管理**子进程，而不是管道本身的数量。

## 2. 展开说明  
在 Shell 中，通过管道（`|`）连接命令（例如 `cmd1 | cmd2 | cmd3`）确实会带来系统开销，但这个开销主要来自于**创建**和**管理**子进程，而不是管道本身的数量。
### 核心机制与开销分析

1. **创建子进程（Forking）：

    - Shell 执行管道操作时，会为管道中的**每个命令**创建一个新的子进程（通过 `fork()` 或 `vfork()` 系统调用）。
        
    - **开销点：** `fork()` 操作需要复制父进程的部分资源（例如内存页表、文件描述符等）。尽管现代 Linux 通过**写时复制（Copy-On-Write, COW）**技术优化了内存复制，但创建进程仍然涉及内核调用、分配内核结构体、设置上下文等，这是一个**相对较重**的操作。
        
2. **创建管道（Piping）：**
    
    - 在创建子进程之前或同时，Shell 会为每对相邻的命令之间创建一个**匿名管道**（通过 `pipe()` 系统调用）。
        
    - **开销点：** 管道操作本身只是在内核中分配一个内存缓冲区（约 64 KB），并返回两个文件描述符（读端和写端）。这个开销与创建进程相比**非常小**。
        
3. **数据传输：**
    
    - 数据通过管道在内核缓冲区中流动。
        
    - **开销点：** 数据在内核空间进行复制（从写进程的用户空间 $\to$ 内核缓冲区 $\to$ 读进程的用户空间）。虽然速度很快，但如果能够避免这种**进程间通信（IPC）**，性能会更好。
        





**示例：**

|**场景**|**推荐做法（少开销）**|**不推荐做法（多开销）**|**解释**|
|---|---|---|---|
|**计算总行数**|`wc -l file.txt`|`cat file.txt|wc -l`|
|**行内文本替换**|`awk '{gsub(/old/, "new"); print}' file.txt`|`cat file.txt|sed 's/old/new/g'`|

**总结：**

Shell 编程的优化核心在于**最小化不必要的进程创建**。管道本身不是主要的性能瓶颈，**通过管道连接的命令越多，创建的子进程就越多，系统开销也就越大。**


## 3. 与其他卡片的关联  
- 前置卡片：
- 后续卡片：
- 相似主题：

## 4. 背景/出处  
- 来源：
- 引文/摘要：  
  - …  
  - …  

## 5. 应用/启发  
- 可以如何应用在工作、学习、生活中  
- 引发的思考与问题  

## 6. 待办/进一步探索  
 
  
