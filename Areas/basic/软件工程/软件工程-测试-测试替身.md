---
tags:
  - fleeting
---
## 1. 核心观点  
### Ⅰ. 概念层

测试替身是一组用于**替代真实依赖、增强测试可控性与可观测性**的设计模式集合。其中，模拟对象（Mock）通过记录并验证交互行为，将“是否正确调用”上升为测试判据。合理使用测试替身，是高质量单元测试与架构解耦的关键。

### Ⅱ. 实现层



### Ⅲ. 原理层

## 2. 背景/出处  
- 来源：
- 引文/摘要：  
  - …  
  - …  

## 3. 展开说明  

### 测试替身（Test Double）的定义

测试替身是一类**在测试环境中用于替代真实依赖对象的占位类型**。其目的不是提供完整功能，而是**隔离被测对象、控制外部行为、观测交互结果**，从而验证实现是否符合预期。

可以将其类比为电影中的特技替身：

- 不承担“真实角色”的全部职责；
- 只完成测试所需的关键动作；
- 降低测试成本与复杂度。
    

---

### 测试替身的核心作用

测试替身主要解决以下工程问题：

- **隔离依赖**：避免数据库、网络、时间、随机性等不稳定因素
- **可控性**：人为设定返回值、错误路径、边界条件
- **可观测性**：记录调用次数、参数、调用顺序
- **可重复性**：保证测试结果确定、可复现

本质上，测试替身是一种**以类型替换实现测试控制权反转**的手段。

---

### 测试替身的分类（经典测试理论）

测试替身并非单一概念，而是一组角色分工明确的模式。

#### Dummy（哑对象）

- 仅用于满足类型或参数要求
- 不参与任何逻辑
- 通常不会被真正使用
    

#### Stub（桩对象）

- 提供**预定义返回值**
- 不关心是否被调用
- 用于驱动被测代码走到特定分支
    

#### Fake（伪对象）

- 具备**简化但可工作的实现**
- 通常用于替代复杂系统（如内存数据库）
- 行为真实，但实现不严谨或不可扩展
    

#### Spy（间谍对象）

- 记录“是否被调用”“调用了什么”
- 事后检查行为
- 本质是**带记录功能的 Stub/Fake**
    

#### Mock（模拟对象）

- 测试替身中**约束力最强**的一类
- 不仅记录行为，还**对行为进行断言**
- 调用顺序、次数、参数不符合预期即测试失败


---

### 模拟对象（Mock）的定义与特性

模拟对象是一种**可验证交互行为的测试替身**，其核心能力在于：

- **记录测试期间发生的调用**
    
- **对这些调用施加显式期望（expectation）**
    
- **将“行为是否正确”作为测试结果的一部分**
    

换言之：

> Mock 不验证“结果值是否正确”，而是验证“过程是否按约定发生”。

---

### Mock 与其他替身的本质差异

关键差异在于**断言位置**：

- Stub / Fake / Spy
    - 测试代码中显式断言结果
- Mock
    - 期望在对象创建时声明
    - 验证在测试结束时自动发生
        

这使 Mock 非常适合：
- 行为驱动测试（BDD）
- 强交互型系统（消息、事件、回调）

但也带来更高的**测试耦合度**。

---

### 在 Rust 语境下的实现基础

在 Rust 中，测试替身通常依托以下语言机制实现：
- **trait 抽象**：以接口替换具体实现
- **依赖注入**：构造函数 / 参数注入
- **所有权与可变性控制**：
    - `RefCell` / `Cell` 记录调用行为
    - `Arc<Mutex<…>>` 支持并发测试

Mock 本质上是：

> **trait + 内部可变性 + 断言逻辑** 的组合体。

---

### 使用场景与设计取舍

适合使用测试替身的场景：

- 外部系统不可控或代价高
    
- 需要覆盖异常与边界路径
    
- 行为正确性比返回值更重要
    

需要谨慎使用 Mock 的情况：

- Mock 过多导致测试与实现强耦合
    
- 重构成本高
    
- 测试描述“怎么做”而不是“做了什么”
    

---

### 总结


---

### 学习方法论

1. **先分清测试目标**：验证结果，还是验证行为
2. **优先使用 Stub / Fake**，仅在必要时使用 Mock
3. **以 trait 为边界设计系统**，让替换实现成为自然行为
4. **警惕过度 Mock**，保持测试对重构的友好性



## 4. 与其他卡片的关联  
- 前置卡片：
- 后续卡片：
- 相似主题：

## 5. 应用/启发  
- 可以如何应用在工作、学习、生活中  
- 引发的思考与问题  

## 6. 待办/进一步探索  
- [ ] 深入阅读 xxx  
- [ ] 验证这个观点的边界条件  
