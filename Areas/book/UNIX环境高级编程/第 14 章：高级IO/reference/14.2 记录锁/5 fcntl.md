提供的内容是对 UNIX/Linux 中 **fcntl 函数**及其用于**记录锁（字节范围锁）**时的参数和返回值结构的完整、规范的描述。

以下是整理后的笔记，聚焦于 fcntl 的记录锁用法：

---

### fcntl 函数用于记录锁 (fcntl for Record Locking)

#### 1. 函数原型和返回值

C

```
#include <fcntl.h>

int fcntl(int fd, int cmd, ... /* struct flock *flockptr */);
```

|参数|类型|描述|
|---|---|---|
|**`fd`**|`int`|要操作的文件描述符。|
|**`cmd`**|`int`|指定要执行的操作。|
|**`...`**|`struct flock *`|当 `cmd` 与记录锁相关时，第三个参数（这里称作 `flockptr`）是一个指向 `struct flock` 结构的指针。|

|返回值|描述|
|---|---|
|**若成功**|**依赖于 cmd。** (例如 F_GETLK 成功返回 0，但 flockptr 结构体会被修改)|
|**若失败**|返回 **−1**，并设置 errno。|

#### 2. 记录锁相关的命令 (`cmd` 值)

|命令|描述|
|---|---|
|**F_GETLK**|**获取锁信息 (查询)**：检查是否已经有锁会阻止请求的锁（由 flockptr 指定）。如果发现冲突，它会修改 flockptr 来描述冲突的锁；如果没有冲突，则将 l_type 设置为 F_UNLCK。|
|**F_SETLK**|**设置/释放锁 (非阻塞)**：尝试设置或释放 flockptr 指定的锁。如果操作无法立即完成（发生冲突），则立即返回 −1 并设置 errno。|
|**F_SETLKW**|**设置/释放锁 (阻塞)**：尝试设置或释放锁。如果发生冲突，进程会**阻塞**，直到锁被释放（或被信号中断）。|

#### 3. struct flock 结构体定义

| 结构体成员        | 类型       | 描述                                                         |
| ------------ | -------- | ---------------------------------------------------------- |
| **l_type**   | `short`  | **锁的类型/操作：** F_RDLCK (共享读锁)、F_WRLCK (独占写锁) 或 F_UNLCK (解锁)。 |
| **l_whence** | `short`  | **起始参照点：** SEEK_SET、SEEK_CUR 或 SEEK_END。                   |
| **l_start**  | `off\_t` | **起始偏移量：** 相对于 l_whence 的字节偏移量。                            |
| **l_len**    | `off\_t` | **锁定长度：** 锁定的字节数；**0** 表示锁扩展到文件最大可能偏移量（EOF）。               |
| **l_pid**    | `pid\_t` | **进程 ID：** **仅由 F_GETLK 返回**，指明持有冲突锁的进程 ID。                |
### fcntl 字节范围锁（锁定区域规则）

这段规则主要说明了如何使用 struct flock 中的 l_start、l_whence 和 l_len 三个字段来精确定义锁定区域。

### 锁定区域的定义和约束：
#### 1. 区域起始点的定位规则

| 规则               | 描述                                                                                   |
| ---------------- | ------------------------------------------------------------------------------------ |
| **参照 lseek**     | 锁定区域起始偏移量的两个元素（l_start 和 l_whence）的使用方式，与 lseek 函数中的最后两个参数（偏移量和参照点）**完全类似**。         |
| **l_whence 可选值** | 可选用的参照点是：SEEK_SET（文件起始）、SEEK_CUR（当前偏移量）或 SEEK_END（文件尾端）。                             |
| **起始位置约束**       | 锁定的起始位置可以在当前**文件尾端处开始**，或者**越过尾端处开始**（适用于锁定未来的追加数据），但是**不能**在文件起始位置之前开始（即绝对偏移量不能为负）。 |

#### 2. 锁定范围和长度 (l_len) 的特殊规则

| 规则              | 描述                                                   | 实际用途                                                                                              |
| --------------- | ---------------------------------------------------- | ------------------------------------------------------------------------------------------------- |
| **l_len=0 的意义** | 当 l_len 设置为 **0** 时，它表示锁定的范围可以扩展到**文件能够达到的最大可能偏移量**。 | 这保证了**不管向该文件中追加写入了多少数据**，这些追加的数据都可以自动处于锁定的范围内。[5.1 起始位置可以是文件中的任意一个位置](5.1%20起始位置可以是文件中的任意一个位置.md) |
| **锁定整个文件**      | 为了锁定整个文件，应将锁定区域的起始点指向文件的起始位置，并将长度 (l_len) 指定为 0。     | **最常用的设置：** l_start = 0，l_whence = SEEK_SET，l_len = 0。                                            |
