TCP 如同前面3.4 节所讲的rdt 协议一样，它采用超时/重传机制来处理报文段的丢失问题。尽管这在概念上简单，但是当在如 TCP这样的实际协议中实现超时/重传机制时还是会产生许多微妙的问题。也许最明显的一个问题就是超时间隔长度的设置。显然，超时间隔必须大于该连接的往返时间(RTT)，即从一个报文段发出到它被确认的时间。否则会造成不必要的重传。但是这个时间间隔到底应该是多大呢?刚开始时应如何估计往返时间呢?是否应该为所有未确认的报文段各设一个定时器?问题竟然如此之多!我们在本节中的讨论基于`[Jacobson1988]`中有关TCP的工作以及IETF关于管理TCP定时器的建议`[RFC6298]`​。
### 1.估计往返时间
我们开始学习 TCP 定时器的管理问题，要考虑一下TCP 是如何估计发送方与接收方之间往返时间的。
- 报文段的样本 RTT(表示为SampleRTT)就是从某报文段被发出(即交给IP)到对该报文段的确认被收到之间的时间量。大多数 TCP的实现仅在某个时刻做一次SampleRTT测量，而不是为每个发送的报文段测量一个Samp-leRTT。这就是说，在任意时刻，**仅为一个已发送的但目前尚未被确认的报文段估计 Samp-leRTT，从而产生一个接近每个 RTT 的新 SampleRTT** 值。另外，**TCP决不为已被重传的报文段计算SampleRTT;它仅为传输一次的报文段测量SampleRTT`[Kan 1987]​`**。(本章后面的一个习题请你考虑一下为什么要这么做。
- 显然，由于路由器的拥塞和端系统负载的变化，这些报文段的 SampleRTT 值会随之波动。由于这种波动，任何给定的 SampleRTT 值也许都是非典型的。因此，为了估计一个典型的RTT，自然要采取某种对SampleRTT 取平均的办法。TCP 维持一个SampleRTT 均值(称为EstimatedRTT)。一旦获得一个新 SampleRTT 时，TCP 就会根据下列公式来更新Esti-matedRTT;
![](Pasted%20image%2020250618154443.png)
图3-32显示了当a=1/8时，在gaia.cs.umass.edu(在美国马萨诸塞州的Amherst)与fantasia.eurecom.fr(在法国南部)之间的一条TCP连接上的SampleRTT值与Estimate-dRTT 值。显然，SampleRTT的变化在EstimatedRTT的计算中趋于平缓了。
![](Pasted%20image%2020250618154550.png)
图3-32 RTT 样本和 RTT 估计
除了估算RTT外，测量RTT的变化也是有价值的。​`[RFC 6298]`定义了 RTT 偏差DevRTT，用于估算SampleRTT一般会偏离EstimatedRTT的程度:
![](Pasted%20image%2020250618154623.png)
注意到DevRTT是一个SampleRTT与EstimatedRTT之间差值的EWMA。如果Samp-leRTT 值波动较小，那么 DevRTT的值就会很小;另一方面，如果波动很大，那么 DevRTT的值就会很大。B的推荐值为0.25。
### 2.设置和管理重传超时间隔
假设已经给出了EstimatedRTT值和DevRTT值，那么TCP超时间隔应该用什么值呢?很明显，超**时间隔应该大于等于 EstimatedRTT，否则，将造成不必要的重传。但是超时间隔也不应该比EstimatedRTT 大太多，否则当报文段丢失时，TCP 不能很快地重传该报文段，导致数据传输时延大**。因此要求将超时间隔设为EstimatedRTT加上一定余量。当SampleRTT 值波动较大时，这个余量应该大些;当波动较小时，这个余量应该小些。因此，DevRTT 值应该在这里发挥作用了。在 TCP 的确定重传超时间隔的方法中，所有这些因素都考虑到了
![](Pasted%20image%2020250618154754.png)
### 实践原则
与我们在3.4节中所学的方法很像，TCP通过使用肯定确认与定时器来提供可靠数据传输。TCP确认正确接收到的数据，而当认为报文段或其确认报文丢失或受损时，TCP 会重传这些报文段。有些版本的TCP还有一个隐式NAK 机制(在TCP的快速重传机制下，收到对一个特定报文段的3个冗余ACK就可作为对后面报文段的一个隐式NAK，从而在超时之前触发对该报文段的重传)。TCP使用序号以使接收方能识别丢失或重复的报文段。像可靠数据传输协议rdt3.0的情况一样，TCP 自己也无法明确地分辨一个报文段或其ACK是丢失了还是受损了，或是时延过长了。在发送方，TCP 的响应是相同的:重传有疑问的报文段。
TCP也使用流水线，使得发送方在任意时刻都可以有多个已发出但还未被确认的报文段存在。我们在前面已经看到，当报文段长度与往返时延之比很小时，流水线可显著地增加一个会话的吞吐量。
- **当单个报文段（数据包）的传输时间相比于整个往返时延（RTT, Round Trip Time）很短时，采用流水线机制能显著提升网络吞吐量。**
一个发送方能够具有的未被确认报文段的具体数量是由 TCP的流量控制和拥塞控制机制决定的。TCP 流量控制将在本节后面讨论;TCP 拥塞控制将在3.7节中讨论。此时我们只需知道TCP发送方使用了流水线。