---
tags:
  - permanent
---
## 1. æ ¸å¿ƒè§‚ç‚¹  
### â… . æ¦‚å¿µå±‚

**Condvarï¼ˆCondition Variableï¼Œæ¡ä»¶å˜é‡ï¼‰** æ˜¯ä¸€ç§ç”¨äº**çº¿ç¨‹é—´åä½œåŒæ­¥**çš„åŸè¯­ï¼Œç”¨æ¥è®©çº¿ç¨‹åœ¨**æŸä¸ªæ¡ä»¶ä¸æ»¡è¶³æ—¶è¿›å…¥ç¡çœ **ï¼Œå¹¶åœ¨**æ¡ä»¶å¯èƒ½æ»¡è¶³æ—¶è¢«å”¤é†’**ã€‚

Condvar **æ°¸è¿œä¸å•ç‹¬ä½¿ç”¨**ï¼Œè€Œæ˜¯ **ä¸ Mutex ç»‘å®š**ï¼Œç”¨äºè§£å†³ä»¥ä¸‹ç»å…¸é—®é¢˜ï¼š
- çº¿ç¨‹éœ€è¦ç­‰å¾…æŸä¸ªå…±äº«çŠ¶æ€å‘ç”Ÿå˜åŒ–
- é¿å…å¿™ç­‰ï¼ˆbusy waitingï¼‰
- å®ç°ç”Ÿäº§è€…-æ¶ˆè´¹è€…ã€èµ„æºå¯ç”¨é€šçŸ¥ç­‰åœºæ™¯
ä¸€å¥è¯æ€»ç»“ï¼š

> **Mutex è´Ÿè´£â€œä¿æŠ¤çŠ¶æ€â€ï¼ŒCondvar è´Ÿè´£â€œç­‰å¾…çŠ¶æ€å˜åŒ–â€ã€‚**


### â…¡. åº”ç”¨å±‚
- [Rust ä¸­ Condvar çš„åŸºæœ¬ API](#Rust%20ä¸­%20Condvar%20çš„åŸºæœ¬%20API)
- [å…¸å‹ä½¿ç”¨èŒƒå¼ï¼ˆå¿…é¡»æŒæ¡ï¼‰](#å…¸å‹ä½¿ç”¨èŒƒå¼ï¼ˆå¿…é¡»æŒæ¡ï¼‰)
- æ¡ˆä¾‹
	- https://github.com/Levio-z/leetcode-rust/blob/master/src/solution/s1114_print_in_order.rs
	- https://github.com/Levio-z/leetcode-rust/blob/master/src/solution/s1115_print_foobar_alternately.rs
### â…¢. å®ç°å±‚

### **IV**.åŸç†å±‚
- [Condvar è§£å†³çš„æ ¸å¿ƒé—®é¢˜ï¼šâ€œçŠ¶æ€å˜åŒ–é€šçŸ¥â€](#Condvar%20è§£å†³çš„æ ¸å¿ƒé—®é¢˜ï¼šâ€œçŠ¶æ€å˜åŒ–é€šçŸ¥â€)
- [æºç å±‚é¢çš„å·¥ä½œåŸç†ï¼ˆç®€åŒ–æ¨¡å‹ï¼‰](#æºç å±‚é¢çš„å·¥ä½œåŸç†ï¼ˆç®€åŒ–æ¨¡å‹ï¼‰)
## 2. èƒŒæ™¯/å‡ºå¤„  
- æ¥æºï¼š
- å¼•æ–‡/æ‘˜è¦ï¼š  
  - â€¦  
  - â€¦  

## 3. å±•å¼€è¯´æ˜  

### Condvar è§£å†³çš„æ ¸å¿ƒé—®é¢˜ï¼š**â€œçŠ¶æ€å˜åŒ–é€šçŸ¥â€**

Condvar è§£å†³çš„æ˜¯ **â€œçŠ¶æ€å˜åŒ–é€šçŸ¥â€** çš„é—®é¢˜ï¼Œè€Œä¸æ˜¯äº’æ–¥æœ¬èº«ã€‚

å¦‚æœåªæœ‰ Mutexï¼š

```text
çº¿ç¨‹ A: ä¸æ–­ lock -> æ£€æŸ¥æ¡ä»¶ -> unlock -> é‡å¤
```

è¿™æ˜¯ **å¿™ç­‰**ï¼Œæµªè´¹ CPUã€‚

Condvar å¼•å…¥åï¼š

```text
çº¿ç¨‹ A: æ¡ä»¶ä¸æ»¡è¶³ -> sleep
çº¿ç¨‹ B: ä¿®æ”¹çŠ¶æ€ -> notify
çº¿ç¨‹ A: è¢«å”¤é†’ -> é‡æ–°æ£€æŸ¥æ¡ä»¶
```

æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š

- **æ¡ä»¶ä¸æ»¡è¶³ï¼šç¡çœ **
- **æ¡ä»¶å¯èƒ½æ»¡è¶³ï¼šå”¤é†’**
- **æ˜¯å¦çœŸçš„æ»¡è¶³ï¼šé‡æ–°æ£€æŸ¥**

---

### Rust ä¸­ Condvar çš„åŸºæœ¬ API

```rust
pub struct Condvar;
```

æ ¸å¿ƒæ–¹æ³•åªæœ‰ä¸‰ä¸ªï¼š

#### 1. `wait`

```rust
fn wait<'a, T>(&self, guard: MutexGuard<'a, T>) -> MutexGuard<'a, T>
```

- **åŸå­åœ°åšä¸¤ä»¶äº‹**
    
    1. é‡Šæ”¾ Mutex
    2. å½“å‰çº¿ç¨‹è¿›å…¥é˜»å¡
        
- è¢«å”¤é†’åï¼š
    - é‡æ–°è·å– Mutex
    - è¿”å›æ–°çš„ MutexGuard

#### 2. `notify_one`

```rust
fn notify_one(&self)
```

- å”¤é†’ **ä¸€ä¸ª** æ­£åœ¨ wait çš„çº¿ç¨‹

#### 3. `notify_all`

```rust
fn notify_all(&self)
```

- å”¤é†’ **æ‰€æœ‰** æ­£åœ¨ wait çš„çº¿ç¨‹

---

### å…¸å‹ä½¿ç”¨èŒƒå¼ï¼ˆå¿…é¡»æŒæ¡ï¼‰

Condvar çš„**æ ‡å‡†ç”¨æ³•æ¨¡å¼**æ˜¯ä¸€ä¸ª **while å¾ªç¯**ï¼Œè€Œä¸æ˜¯ ifã€‚

```rust
let mut guard = mutex.lock().unwrap();
while !condition(&*guard) {
    guard = condvar.wait(guard).unwrap();
}
// æ¡ä»¶æ»¡è¶³ï¼Œå®‰å…¨ä½¿ç”¨ guard
```

**åŸå› **ï¼ˆéå¸¸é‡è¦ï¼‰ï¼š

1. **è™šå‡å”¤é†’ï¼ˆSpurious Wakeupï¼‰**
2. è¢«å”¤é†’ â‰  æ¡ä»¶ä¸€å®šæ»¡è¶³
3. å¤šçº¿ç¨‹ç«äº‰ä¸‹æ¡ä»¶å¯èƒ½è¢«å…¶ä»–çº¿ç¨‹æŠ¢å…ˆæ”¹å˜

ğŸ‘‰ **Condvar çš„æ­£ç¡®æ€§æ¥è‡ª whileï¼Œè€Œä¸æ˜¯ Condvar æœ¬èº«**

---

### æºç å±‚é¢çš„å·¥ä½œåŸç†ï¼ˆç®€åŒ–æ¨¡å‹ï¼‰

ä»å®ç°å±‚é¢çœ‹ï¼ŒCondvar æœ¬è´¨ä¸Šæ˜¯
- ä¸€ä¸ª **ç­‰å¾…é˜Ÿåˆ—**
    
- OS æä¾›çš„é˜»å¡/å”¤é†’æœºåˆ¶ï¼ˆfutex / pthread_cond / park/unparkï¼‰
        

ä¼ªæµç¨‹å¦‚ä¸‹ï¼š

#### wait å†…éƒ¨é€»è¾‘ï¼ˆæŠ½è±¡ï¼‰

```text
1. æŠŠå½“å‰çº¿ç¨‹åŠ å…¥ Condvar çš„ç­‰å¾…é˜Ÿåˆ—
2. åŸå­åœ°é‡Šæ”¾ Mutex
3. é˜»å¡å½“å‰çº¿ç¨‹
4. è¢« notify å”¤é†’
5. é‡æ–°å°è¯•è·å– Mutex
6. è¿”å› MutexGuard
```

#### notify å†…éƒ¨é€»è¾‘ï¼ˆæŠ½è±¡ï¼‰

```text
1. ä»ç­‰å¾…é˜Ÿåˆ—ä¸­é€‰æ‹©ä¸€ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹
2. å°†å…¶æ ‡è®°ä¸ºå¯è¿è¡Œ
```

**å…³é”®ç‚¹**ï¼š

- Condvar **ä¸ä¿å­˜æ¡ä»¶**
    
- æ¡ä»¶å®Œå…¨ç”± Mutex ä¿æŠ¤çš„æ•°æ®å†³å®š
    

---

### å…­ã€ç»å…¸ç¤ºä¾‹ï¼šç”Ÿäº§è€…-æ¶ˆè´¹è€…ï¼ˆå•ç¼“å†²ï¼‰

```rust
use std::sync::{Arc, Mutex, Condvar};
use std::thread;

fn main() {
    let pair = Arc::new((Mutex::new(None), Condvar::new()));

    // æ¶ˆè´¹è€…
    {
        let pair = pair.clone();
        thread::spawn(move || {
            let (lock, cvar) = &*pair;
            let mut data = lock.lock().unwrap();
            while data.is_none() {
                data = cvar.wait(data).unwrap();
            }
            println!("consume {:?}", data.take());
        });
    }

    // ç”Ÿäº§è€…
    {
        let (lock, cvar) = &*pair;
        let mut data = lock.lock().unwrap();
        *data = Some(42);
        cvar.notify_one();
    }
}
```

è¿™ä¸ªä¾‹å­å®Œæ•´ä½“ç°äº†ï¼š

- Mutexï¼šä¿æŠ¤å…±äº«çŠ¶æ€ `Option<T>`
    
- Condvarï¼šç­‰å¾…/é€šçŸ¥çŠ¶æ€å˜åŒ–
    
- whileï¼šä¿è¯æ­£ç¡®æ€§
    

---

### ä¸ƒã€Condvar çš„ä½¿ç”¨åœºæ™¯

é€‚åˆä½¿ç”¨ Condvar çš„åœºæ™¯ï¼š

- ç”Ÿäº§è€… / æ¶ˆè´¹è€…
- ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºæ—¶ç­‰å¾…
- èµ„æºæ± æ— å¯ç”¨èµ„æºæ—¶é˜»å¡
- æœ‰ç•Œç¼“å†²åŒºï¼ˆbounded bufferï¼‰
- çŠ¶æ€æœºä¸­â€œç­‰å¾…æŸçŠ¶æ€å‡ºç°â€
    

**ä¸é€‚åˆçš„åœºæ™¯**ï¼š

- çº¯äº‹ä»¶é©±åŠ¨ï¼ˆå¯ç”¨ channelï¼‰
- async/awaitï¼ˆåº”ä½¿ç”¨ async condvar æˆ– Notifyï¼‰
- å•çº¿ç¨‹åŒæ­¥
    

---

### å…«ã€Condvar ä¸å…¶ä»–åŒæ­¥åŸè¯­å¯¹æ¯”ï¼ˆé‡ç‚¹ï¼‰

|åŸè¯­|å…³æ³¨ç‚¹|æ˜¯å¦é˜»å¡|æ˜¯å¦ä¿æŠ¤æ•°æ®|
|---|---|---|---|
|Mutex|äº’æ–¥|æ˜¯|æ˜¯|
|Condvar|æ¡ä»¶å˜åŒ–|æ˜¯|å¦|
|Channel|æ¶ˆæ¯ä¼ é€’|æ˜¯|æ˜¯|
|Atomic|å•å˜é‡|å¦|å¦|
|Semaphore|èµ„æºè®¡æ•°|æ˜¯|éƒ¨åˆ†|

**å…³é”®è®¤çŸ¥**ï¼š

> Condvar æ˜¯â€œç­‰å¾…æ¡ä»¶â€ï¼Œä¸æ˜¯â€œä¼ é€’æ•°æ®â€ã€‚

---

### ä¹ã€å¸¸è§é”™è¯¯ä¸åæ¨¡å¼

#### 1. ç”¨ if è€Œä¸æ˜¯ whileï¼ˆâŒï¼‰

```rust
if !ready {
    condvar.wait(guard);
}
```

#### 2. wait ä¸æŒæœ‰ Mutexï¼ˆâŒï¼‰

Condvar **å¿…é¡»åœ¨æŒé”çŠ¶æ€ä¸‹ wait**

#### 3. notify ä¸ä¿®æ”¹æ¡ä»¶ï¼ˆâŒï¼‰

```rust
condvar.notify_one(); // ä½†æ¡ä»¶æ²¡å˜
```

è¿™ä¼šå¯¼è‡´**æ— æ„ä¹‰å”¤é†’**

---

### åã€æ€»ç»“ä¸å­¦ä¹ æ–¹æ³•è®º

#### å†…å®¹æ€»ç»“

- Condvar æ˜¯ **æ¡ä»¶ç­‰å¾… + é€šçŸ¥æœºåˆ¶**
    
- **å¿…é¡»ä¸ Mutex æ­é…**
    
- æ­£ç¡®ä½¿ç”¨æ¨¡å¼ï¼š`while + wait`
    
- Condvar ä¸å­˜æ¡ä»¶ï¼Œæ¡ä»¶åœ¨å…±äº«çŠ¶æ€ä¸­
    
- notify â‰  æ¡ä»¶æ»¡è¶³ï¼Œåªæ˜¯â€œå¯èƒ½æ»¡è¶³â€
    

#### å­¦ä¹ è¯¥å—å†…å®¹çš„æ–¹æ³•è®º

1. **ä»é—®é¢˜å‡ºå‘**ï¼šå…ˆæ€è€ƒâ€œæˆ‘åœ¨ç­‰ä»€ä¹ˆï¼Ÿâ€
    
2. **æ˜ç¡®çŠ¶æ€å˜é‡**ï¼šç”¨ Mutex ä¿æŠ¤
    
3. **æ˜ç¡®ç­‰å¾…æ¡ä»¶**ï¼šç”¨ while è¡¨è¾¾
    
4. **æ˜ç¡®å”¤é†’æ—¶æœº**ï¼šä¿®æ”¹çŠ¶æ€å notify
    
5. **ç»“åˆæºç é˜…è¯»**ï¼šç†è§£ wait çš„â€œåŸå­é‡Šæ”¾ + é˜»å¡â€
    

#### æ¨èç»ƒä¹ ï¼ˆéå¸¸é‡è¦ï¼‰

1. å®ç°ä¸€ä¸ª **æœ‰ç•Œé˜Ÿåˆ—ï¼ˆå®¹é‡ Nï¼‰**
    
2. å®ç° **è¯»è€…-å†™è€…é—®é¢˜**
    
3. ç”¨ Condvar å®ç° **ä¸€æ¬¡æ€§å±éšœï¼ˆBarrierï¼‰**
    
4. å¯¹æ¯”å®ç°ï¼šCondvar vs Channel
    

#### éœ€è¦é‡ç‚¹å…³æ³¨çš„åº•å±‚çŸ¥è¯†ï¼ˆä»·å€¼æœ€é«˜ï¼‰

- **è™šå‡å”¤é†’çš„åŸå› **
    
- **wait çš„åŸå­æ€§è¯­ä¹‰**
    
- OS å±‚çš„ futex / park-unpark
    
- Mutex ä¸ Condvar çš„å†…å­˜å¯è§æ€§ä¿è¯
    
- ä¸ºä»€ä¹ˆ async ä¸–ç•Œä¸ç”¨ std::sync::Condvar
    

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥å¯ä»¥ç›´æ¥**ä»æ ‡å‡†åº“æºç è§’åº¦æ‹†è§£ `Condvar::wait` çš„å®ç°è·¯å¾„**ï¼Œè¿™æ˜¯ç†è§£çº¿ç¨‹åŒæ­¥çš„ä¸€ä¸ªåˆ†æ°´å²­ã€‚
## 4. ä¸å…¶ä»–å¡ç‰‡çš„å…³è”  
- å‰ç½®å¡ç‰‡ï¼š
- åç»­å¡ç‰‡ï¼š
	- [Rust-å¼‚æ­¥ç¼–ç¨‹-join!](../è¯­æ³•/Rust-å¼‚æ­¥ç¼–ç¨‹-join!.md)
	- [Rust-å¼‚æ­¥ç¼–ç¨‹-await-await!](Rust-å¼‚æ­¥ç¼–ç¨‹-await-await!.md)
- ç›¸ä¼¼ä¸»é¢˜ï¼š

## 5. åº”ç”¨/å¯å‘  
- å¯ä»¥å¦‚ä½•åº”ç”¨åœ¨å·¥ä½œã€å­¦ä¹ ã€ç”Ÿæ´»ä¸­  
- å¼•å‘çš„æ€è€ƒä¸é—®é¢˜  

## 6. å¾…åŠ/è¿›ä¸€æ­¥æ¢ç´¢  
 
  
