### Rust `#![feature(custom_test_frameworks)]` 与 `#![test_runner(...)]` 详解

#### 1\. `#![feature(custom_test_frameworks)]`

-   **定义**：启用 Rust 的 **不稳定特性** `custom_test_frameworks`。
    
-   **作用**：
    
    1.  允许用户 **替换默认测试框架**（`libtest`）。
        
    2.  使 `#[test_case]` 属性可用，从而收集测试函数列表。
        
    3.  可在 **`#[no_std]` / 裸机环境**下执行测试，无需依赖 `std`。
        
-   **使用方式**：
    
    ```rust
    #![feature(custom_test_frameworks)]
    ```
    
    必须放在 crate 根（通常在 `lib.rs` 或 `main.rs` 顶部），并且只在 nightly Rust 中可用。
    

---

#### 2\. `#![test_runner(crate::test_runner)]`

-   **定义**：指定一个 **自定义测试 runner** 函数，用于执行收集到的测试函数。
    
-   **作用**：
    
    1.  替代默认的 `libtest` 执行逻辑。
        
    2.  编译器会将所有带 `#[test_case]` 的函数收集成 **函数切片 `&[&dyn Fn()]`**。
        
    3.  将这个切片传入你指定的 runner 函数，例如：
        
        ```rust
        fn test_runner(tests: &[&dyn Fn()]) {
            for test in tests {
                test();
            }
        }
        ```
        
-   **语法说明**：
    
    -   `crate::test_runner` 表示 runner 函数在本 crate 根模块下。
        
    -   runner 函数签名通常为：
        
        ```rust
        fn(&[&dyn Fn()])
        ```
        
        即接受一个 **测试函数切片**，每个元素是一个无参数、无返回值的函数指针（`Fn()`）。
        
    -   运行逻辑完全由用户控制，可以添加日志、统计执行时间或处理测试失败。
        

---

#### 3\. 示例

```rust
#![no_std]
#![no_main]
#![feature(custom_test_frameworks)]
#![test_runner(crate::test_runner)]

use core::panic::PanicInfo;

// 自定义 panic 处理
#[panic_handler]
fn panic(_info: &PanicInfo) -> ! {
    loop {}
}

// 自定义 runner
fn test_runner(tests: &[&dyn Fn()]) {
    for test in tests {
        test();
    }
}

// 测试函数
#[test_case]
fn example_test() {
    assert_eq!(2 + 2, 4);
}
```

-   `#[test_case]` 被收集并交给 `test_runner` 执行。
    
-   你可以在 runner 内部实现复杂逻辑，比如失败统计、异常处理等。
    

---