---
tags:
  - note
---
## 1. 核心观点  
- **fan-in 是“多生产者 → 单消费者”的并发汇聚模型**
- 它通过集中消费换取：
    - 清晰顺序
    - 简单语义
    - 强 happens-before
- Rust 的 `mpsc` 在类型系统中**原生支持并强制 fan-in**
- fan-in 不是性能模型，而是**语义模型**

- 定义：[初始设置：fan-in 模型的精确定义](Rust-mpsc-fan-in-基本概念.md#初始设置：fan-in%20模型的精确定义)
- 特征：[初始设置：fan-in 的核心结构特征](#初始设置：fan-in%20的核心结构特征)
- 原理：[初始设置：fan-in 的并发原理（为什么安全）](Rust-mpsc-fan-in-基本概念.md#初始设置：fan-in%20的并发原理（为什么安全）)
	1. **不会重复消费**
	2. **不会丢消息**
	3. **消费顺序清晰**
- 优点和代价：[fan-in 的优点与代价](#fan-in%20的优点与代价)
- 应用场景：[初始设置：典型使用场景（工程级）](#初始设置：典型使用场景（工程级）)

## 2. 背景/出处  
- 来源：
- 引文/摘要：  
  - …  
  - …  

## 3. 展开说明  

### 初始设置：fan-in 模型的精确定义

**fan-in（汇聚模型）**指的是：

> **多个生产者（sources）将数据/事件汇聚到一个统一的消费点（sink）进行处理**
形式化表示为：
```
P1 \
P2  \
P3   --->  C
P4  /
```

- 多输入
- 单输出
- 消费端是**唯一的顺序观察者**

---

### 初始设置：fan-in 的核心结构特征

fan-in 具备三个结构性特征：
1. **输入并发**
    - 多个生产者可同时产生数据
2. **输出串行**
    - 消费者以某种顺序观察所有输入
3. **汇聚点唯一**
    - 所有事件在此“收敛”为一条逻辑时间线

👉 这使得 fan-in **天然适合建立全序（total order）**

---

### 初始设置：fan-in 的并发原理（为什么安全）

fan-in 的关键不是“并发消费”，而是：

> **并发写入 + 顺序读取**

[Rust-mpsc-fan-in-并发原理](Rust-mpsc-fan-in-并发原理.md)


### 初始设置：fan-in 的 happens-before 语义

```
send()  happens-before  recv()
```

在 fan-in 中进一步体现为：

- 每个生产者内部：顺序可控
- 不同生产者之间：顺序由队列仲裁
- 消费者看到的是：**线性化后的事件流**

👉 fan-in 是**构造全局时间线**的最简单方式

---

### 初始设置：典型使用场景（工程级）

1. **日志系统**
    - 多线程写日志 → 单线程落盘
2. **事件收集器**
    - 多源事件 → 中央调度
3. **指标聚合**
    - 多 worker → 单统计器
4. **顺序依赖控制**
    - 如 [1114. Print in Order](../../../../../../../../basic/算法和数据机构/Area/atomic/LeetCode/Doing/1114.%20Print%20in%20Order.md)
5. **Actor 模型中的 Mailbox**
    - 多 actor → 单 actor 实例

---

### fan-in 的优点与代价

**优点**
- 语义简单
- 顺序明确
- 易于推理和调试
**代价**
-  吞吐受限于单消费者,消费端可能成为瓶颈
	- **吞吐量瓶颈**：汇聚点（Single Consumer）的处理能力上限就是整个系统的上限。
	- **背压（Backpressure）**：如果全序的处理速度跟不上并发的输入速度，汇聚点必须具备缓冲或拒绝策略。
- 不适合 CPU 密集型并行消费
	- **延迟（Latency）**：原本可以并行处理的任务，为了获得“全序”而被迫进入队列等待。

👉 当消费逻辑重时，应考虑 **fan-out 或 MPMC**

---

## 学习方法论与练习

**方法论**
- 看并发模型，先画数据流图
- 再问：我需要的是“顺序”还是“并行”

**练习**
1. 用 mpsc 写一个多线程日志收集器
2. 改为 crossbeam MPMC，对比语义复杂度
3. 在 fan-in 前加一个本地 buffer，观察背压
    

## 4. 与其他卡片的关联  
- 前置卡片：
- 后续卡片：
	- [Rust-fall-in和fall-out对比](../fall-out/Rust-fall-in和fall-out对比.md)
	- [Rust-mpsc-fan-in-并发原理](Rust-mpsc-fan-in-并发原理.md)
- 相似主题：

## 5. 应用/启发  
- 可以如何应用在工作、学习、生活中  
- 引发的思考与问题  

## 6. 待办/进一步探索  
 
  
