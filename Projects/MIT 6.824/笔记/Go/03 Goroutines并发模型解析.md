## ğŸ”¹1. Goroutine çš„å®šä¹‰ä¸æœ¬è´¨

### âœ… å®šä¹‰ï¼š

> **Goroutine æ˜¯ Go è¯­è¨€ä¸­æ‰§è¡Œå¹¶å‘ä»»åŠ¡çš„åŸºæœ¬å•ä½**ã€‚å®ƒæ˜¯ä¸€ä¸ª **ç”± Go è¿è¡Œæ—¶ç®¡ç†çš„è½»é‡çº§çº¿ç¨‹**ï¼Œè¿è¡ŒäºåŒä¸€åœ°å€ç©ºé—´ä¸­ã€‚

* é€šè¿‡å…³é”®å­— `go` å¯åŠ¨
* è‡ªåŠ¨ç”± Go runtime è°ƒåº¦åˆ°å¤šä¸ª OS çº¿ç¨‹ä¸Š
* æ ˆå¾ˆå°ï¼ˆåˆå§‹ 2KBï¼‰ï¼Œå¯åŠ¨æ€å¢é•¿ï¼ˆæœ€å¤§ 1GBï¼‰

 Goroutine æ˜¯ Go å¹¶å‘çš„åŸºæœ¬æ‰§è¡Œå•ä½
ğŸ“Œ å…³é”®è¯ï¼šâ€œåŸºæœ¬å•ä½â€
æ¯ä¸€ä¸ªå¹¶å‘ä»»åŠ¡ï¼ˆå¦‚å¤„ç†ä¸€ä¸ªè¿æ¥ã€ä¸€ä¸ªè¯·æ±‚ã€ä¸€ä¸ªå­ä»»åŠ¡ï¼‰éƒ½å¯ä»¥åœ¨ä¸€ä¸ª goroutine ä¸­æ‰§è¡Œã€‚

goroutine æ˜¯ Go çš„æœ€å°è°ƒåº¦å•å…ƒï¼ˆç±»ä¼¼çº¿ç¨‹å¯¹æ“ä½œç³»ç»Ÿçš„æœ€å°è°ƒåº¦å•å…ƒï¼‰ã€‚
 è¿è¡ŒäºåŒä¸€åœ°å€ç©ºé—´ä¸­

- goroutine å…±äº«åœ°å€ç©ºé—´ï¼Œå³ï¼š
    
    - æ‰€æœ‰ goroutine å¯ä»¥è®¿é—®ç›¸åŒçš„å˜é‡ã€å †ã€å †æ ˆç©ºé—´ã€‚
        
    - æ‰€ä»¥å®ƒä»¬ä¸æ˜¯ **å¤šè¿›ç¨‹**ï¼ˆprocessï¼‰æ¨¡å‹ï¼Œè€Œæ˜¯æ›´æ¥è¿‘çº¿ç¨‹ï¼ˆä½†æ›´è½»é‡ï¼‰ã€‚
        
- å› æ­¤ï¼š
    
    - ä¸åŒ goroutine é—´è¦é¿å…å…±äº«æ•°æ®çš„ç«æ€ï¼Œæ¨èä½¿ç”¨ **channel** é€šä¿¡ã€‚
        
    - Go è®¾è®¡å“²å­¦ï¼šâ€œ**ä¸è¦é€šè¿‡å…±äº«å†…å­˜æ¥é€šä¿¡ï¼›è¦é€šè¿‡é€šä¿¡æ¥å…±äº«å†…å­˜**â€ã€‚
æ ˆå¾ˆå°ï¼ˆåˆå§‹ 2KBï¼‰ï¼Œå¯åŠ¨æ€å¢é•¿ï¼ˆæœ€å¤§ 1GBï¼‰
- æ¯ä¸ª goroutine åœ¨åˆ›å»ºæ—¶åªåˆ†é… **çº¦ 2KB æ ˆå†…å­˜**
    
- Go ä½¿ç”¨ **åˆ†æ®µæ ˆ/è¿ç»­æ ˆæœºåˆ¶ï¼ˆå½“å‰ç‰ˆæœ¬æ˜¯è¿ç»­æ ˆï¼‰**ï¼Œåœ¨éœ€è¦æ—¶ **è‡ªåŠ¨æ‰©å®¹**
    
- é¿å…äº†åƒ C è¯­è¨€ä¸­çº¿ç¨‹ä½¿ç”¨å›ºå®šæ ˆå¤§å°çš„é—®é¢˜ï¼ˆå®¹æ˜“çˆ†æ ˆæˆ–æµªè´¹å†…å­˜ï¼‰
å®ç°ç»†èŠ‚ï¼ˆç®€è¦ï¼‰
- æ ˆå¢é•¿ä¾é è¿è¡Œæ—¶æ¢æµ‹æœºåˆ¶ï¼ˆå‡½æ•°è°ƒç”¨æ—¶æ£€æŸ¥æ˜¯å¦è¿˜æœ‰ç©ºé—´ï¼‰
    
- è°ƒç”¨æ·±åº¦å˜å¤§æ—¶ï¼Œä¼šè§¦å‘ `morestack` çš„æ ˆæ‹·è´é€»è¾‘
    
- æ ˆå†…æ•°æ®ä¼šè¢«**ç§»åŠ¨**ï¼ŒæŒ‡é’ˆä¼šè¢«ä¿®æ­£

ä¸æ˜¯è¯´ goroutine å°±æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œè€Œæ˜¯å®ƒå…·å¤‡â€œçº¿ç¨‹çš„å¤§éƒ¨åˆ†è¯­ä¹‰èƒ½åŠ›â€ï¼Œä½†å´æ›´åŠ è½»é‡ï¼š

|æ–¹é¢|å«ä¹‰|
|---|---|
|è½»é‡çš„åˆ›å»º|åˆ›å»ºæˆæœ¬ä½ï¼Œæ— éœ€ç³»ç»Ÿè°ƒç”¨|
|è½»é‡çš„åˆ‡æ¢|åˆ‡æ¢ä»£ä»·ä½ï¼Œä¸éœ€è¦é™·å…¥å†…æ ¸|
|è½»é‡çš„æ ˆ|æ ˆå¾ˆå°ï¼Œå¯æŒ‰éœ€è‡ªåŠ¨å¢é•¿|
|è½»é‡çš„é€šä¿¡|ä½¿ç”¨ channelï¼Œå¤©ç„¶æ”¯æŒ CSP å¹¶å‘æ¨¡å¼|

* * *

## ğŸ”¹2. ä¸ºä»€ä¹ˆä¸æ˜¯å« Thread æˆ– Coroutineï¼Ÿ

ä¼ ç»Ÿæœ¯è¯­å«ä¹‰ä¸å‡†ï¼š

| æœ¯è¯­                   | å«ä¹‰æˆ–å…¸å‹å®ç°                   | ä¸ºä»€ä¹ˆä¸å‡†ç¡®ç”¨äº Go                 |
| -------------------- | ------------------------- | --------------------------- |
| Thread               | OS çº§çº¿ç¨‹ï¼Œä¸€èˆ¬å‡  MB æ ˆï¼Œè°ƒåº¦æˆæœ¬é«˜     | Goroutines æ ˆæ›´å°ï¼Œå¯æˆåƒä¸Šä¸‡ä¸ª       |
| Coroutine            | é€šå¸¸æ‰‹åŠ¨ yieldï¼Œåä½œå¼è°ƒåº¦          | Go æ˜¯ **æŠ¢å å¼è°ƒåº¦**ï¼ˆä» Go 1.14 èµ·ï¼‰ |
| Fiber / Green Thread | ç”¨æˆ·ç©ºé—´è°ƒåº¦çº¿ç¨‹ï¼Œé€šå¸¸ä¸ coroutine æ¥è¿‘ | Go æ›´æŠ½è±¡ã€è‡ªåŠ¨è°ƒåº¦                 |

æ‰€ä»¥ Go å‘æ˜äº†â€œ**goroutine**â€è¿™ä¸ªæ–°è¯ï¼Œå¼ºè°ƒå…¶ **å¹¶å‘æ¨¡å‹çš„ç‹¬ç‰¹æ€§ä¸è½»é‡çº§**ã€‚

* * *

## ğŸ”¹3. å·¥ä½œåŸç†ï¼šM:N è°ƒåº¦æ¨¡å‹



Go ä½¿ç”¨ **M:N è°ƒåº¦æ¨¡å‹**ï¼š

> å¤šä¸ª Goroutines (G) ä¼šè¢«è°ƒåº¦åˆ°æ›´å°‘çš„ OS Threads (M) ä¸Šï¼Œè¿™äº›çº¿ç¨‹ç”±è‹¥å¹²ä¸ªè°ƒåº¦å™¨ (P) ååŠ©ç®¡ç†ã€‚

#### Go è°ƒåº¦å™¨çš„ä¸‰éƒ¨åˆ†ç»“æ„ï¼š

* **Gï¼ˆGoroutineï¼‰**ï¼šè¦è¿è¡Œçš„åç¨‹ä»»åŠ¡
    
* **Mï¼ˆMachineï¼‰**ï¼šå®é™…çš„æ“ä½œç³»ç»Ÿçº¿ç¨‹
    
* **Pï¼ˆProcessorï¼‰**ï¼šè°ƒåº¦å™¨ä¸Šä¸‹æ–‡ï¼Œå†³å®šå½“å‰çº¿ç¨‹è¿è¡Œå“ªäº› G
    

è¿™ä¸ªæ¨¡å‹ç§°ä¸º **GMP æ¨¡å‹**ï¼Œç”± `runtime` åŒ…ä¸­çš„è°ƒåº¦å™¨è´Ÿè´£å®ç°ã€‚
- Go ä¼šè‡ªåŠ¨å°†å¤šä¸ª goroutines åˆ†é…åˆ°å¯ç”¨çš„ M ä¸Šè¿è¡Œã€‚
    
- ä¸€ä¸ª M åœ¨ä»»ä¸€æ—¶åˆ»åªèƒ½æ‰§è¡Œä¸€ä¸ª Gã€‚
    
- å¤šä¸ª M å¯ä»¥è¿è¡Œåœ¨å¤šæ ¸ CPU ä¸Šï¼Œå®ç°**çœŸæ­£å¹¶å‘**ã€‚
* * *

## ğŸ”¹4. å¯åŠ¨ Goroutine çš„è¯­æ³•å’Œç¤ºä¾‹

```go
go list.Sort()  // å¼‚æ­¥æ‰§è¡Œ list.Sortï¼Œä¸ç­‰å¾…
```
- è¯¥å‡½æ•°ä¼šâ€œå¼‚æ­¥â€æ‰§è¡Œ
    
- å½“å‰å‡½æ•°ä¸ä¼šç­‰å¾…å®ƒå®Œæˆ
    
- goroutine ç»“æŸæ—¶**è‡ªåŠ¨é”€æ¯**ï¼ˆé™¤éæ³„éœ²ï¼‰

### å‡½æ•°å­—é¢é‡ + goroutineï¼š

```go
go func() {
    time.Sleep(delay)
    fmt.Println(message)
}()
```

* ç»“å°¾çš„ `()` å¾ˆå…³é”®ï¼Œè¡¨ç¤º**ç«‹å³è°ƒç”¨åŒ¿åå‡½æ•°**
    
* åŒ¿åå‡½æ•°é—­åŒ…å¯æ•è·å¤–éƒ¨å˜é‡
    

* * *

## ğŸ”¹5. Goroutine æ˜¯é—­åŒ…ï¼ˆClosureï¼‰

åœ¨ Go ä¸­ï¼Œ**å‡½æ•°å­—é¢é‡å°±æ˜¯é—­åŒ…**ï¼Œæ„å‘³ç€ï¼š

* å¤–éƒ¨å˜é‡çš„å¼•ç”¨ä¼šè¢«â€œæ•è·â€
    
* æ•è·çš„å˜é‡åœ¨ goroutine å­˜æ´»æœŸé—´ä¸ä¼šè¢«é‡Šæ”¾
    

ä¾‹å­ï¼š

```go
func Announce(msg string) {
    go func() {
        fmt.Println(msg)  // msg è¢«é—­åŒ…æ•è·
    }()
}
```

æ³¨æ„ï¼š

* è¢«æ•è·çš„æ˜¯**å˜é‡å¼•ç”¨**ï¼Œä¸æ˜¯å€¼æ‹·è´
    
* å¹¶å‘è®¿é—®å¯èƒ½å¼•èµ· **æ•°æ®ç«äº‰**
    

* * *

## ğŸ”¹6. é€šå¸¸è¿˜éœ€è¦ Channels

å¦‚æ–‡ä¸­æ‰€è¯´ï¼Œgoroutine é»˜è®¤**æ²¡æœ‰è¿”å›å€¼**ï¼Œæ— æ³•é€šçŸ¥å¤–éƒ¨â€œæˆ‘æ‰§è¡Œå®Œäº†â€ï¼Œæ‰€ä»¥éœ€è¦ï¼š

> **Channels**ï¼šç”¨äº goroutine ä¹‹é—´çš„åŒæ­¥ã€é€šä¿¡ã€å®Œæˆä¿¡å·ä¼ é€’

ç¤ºä¾‹ï¼š

```go
done := make(chan bool)

go func() {
    time.Sleep(1 * time.Second)
    fmt.Println("Done!")
    done <- true
}()

<-done  // ç­‰å¾… goroutine å®Œæˆ
```

* * *

## ğŸ”¹7. ä½¿ç”¨åœºæ™¯

* å¹¶å‘ç½‘ç»œæœåŠ¡ï¼ˆå¦‚ HTTP æœåŠ¡å™¨ä¸­çš„æ¯ä¸ªè¿æ¥ï¼‰
    
* å¹¶å‘æ•°æ®å¤„ç†ï¼ˆå¦‚ map-reduceï¼‰
    
* å»¶è¿Ÿå¼‚æ­¥ä»»åŠ¡ï¼ˆå¦‚ç¼“å­˜å¤±æ•ˆååˆ·æ–°ï¼‰
    
* å¯ç»„åˆå¹¶å‘ç»„ä»¶ï¼ˆé…åˆ channel æ„å»º pipelineï¼‰
    

* * *

## ğŸ”¹8. æºç åŠè°ƒåº¦æœºåˆ¶åˆ†æï¼ˆç®€è¦ï¼‰

Go çš„è°ƒåº¦å™¨å®ç°äº `runtime/proc.go`ï¼Œæ ¸å¿ƒåŒ…æ‹¬ï¼š

* **`newproc`**ï¼šå¯åŠ¨ goroutine çš„å…¥å£
    
* **`schedule`**ï¼šè°ƒåº¦å™¨ä¸»å¾ªç¯ï¼Œé€‰æ‹©å“ªä¸ª G è¿è¡Œ
    
* **`gosched`**ï¼šä¸»åŠ¨è®©å‡º CPUï¼ˆè®©å…¶ä»– G æœ‰æœºä¼šè¿è¡Œï¼‰
    
* **`findrunnable`**ï¼šå¯»æ‰¾ä¸‹ä¸€ä¸ªå¯ä»¥è¿è¡Œçš„ G
    

è°ƒåº¦å™¨é€šè¿‡ P ä¸­çš„æœ¬åœ°é˜Ÿåˆ—ã€å…¨å±€é˜Ÿåˆ—ã€æŠ¢å æœºåˆ¶ã€work stealing ç­‰ç­–ç•¥ï¼Œä¿è¯é«˜å¹¶å‘æ—¶ä¾ç„¶é«˜æ•ˆã€‚

* * *

## ğŸ”¹9. æ‰©å±•å¯¹æ¯”ï¼šGoroutine vs å…¶ä»–æ¨¡å‹

| æ¨¡å‹ | æ ˆå¤§å° | è°ƒåº¦æ–¹å¼ | æ˜¯å¦æŠ¢å  | å¯åŠ¨æˆæœ¬ | æ˜¯å¦ç”¨æˆ·ç©ºé—´ |
| --- | --- | --- | --- | --- | --- |
| Goroutine | èµ·å§‹2KBï¼Œå¯å¢é•¿ | GMPè°ƒåº¦å™¨ | æ˜¯ | éå¸¸ä½ | æ˜¯ |
| Thread (C/Java) | é€šå¸¸å‡ MB | OSè°ƒåº¦ | æ˜¯ | è¾ƒé«˜ | å¦ |
| Coroutine (Python) | å›ºå®šå°æ ˆ | æ‰‹åŠ¨yield | å¦ | è¾ƒä½ | æ˜¯ |
| async/await (JS) | æ— æ ˆ | äº‹ä»¶å¾ªç¯ | å¦ | è¾ƒä½ | æ˜¯ |

* * *

## ğŸ”¹10. å°ç»“ä¸è®°å¿†è¦ç‚¹

| ç‚¹ä½ | å†…å®¹ |
| --- | --- |
| ğŸ§  åç§° | goroutine â‰  thread â‰  coroutine |
| âš™ï¸ æ¨¡å‹ | GMPè°ƒåº¦å™¨ï¼ŒM:Næ˜ å°„ |
| ğŸ“¦ æ ˆ | èµ·å§‹2KBï¼ŒæŒ‰éœ€å¢é•¿è‡³æœ€å¤§1GB |
| ğŸ§µ è°ƒåº¦ | æŠ¢å å¼è°ƒåº¦ï¼Œä» Go 1.14 èµ·é»˜è®¤å¯ç”¨ |
| ğŸ”„ é€šä¿¡ | æ¨èé…åˆ channel ä½¿ç”¨ |
| ğŸ’¡ ç‰¹ç‚¹ | å¯åŠ¨å¿«ã€å†…å­˜çœã€ç™¾ä¸‡å¹¶å‘éæ¢¦ |

* * *

å¦‚ä½ æœ‰å…´è¶£ï¼Œæˆ‘å¯ä»¥ç»§ç»­æ·±å…¥è®²è§£ä»¥ä¸‹å†…å®¹ï¼ˆå¯é€‰æ‹©ï¼‰ï¼š

1. `runtime.newproc` æºç åˆ†æï¼ˆå¯åŠ¨ goroutine çš„åº•å±‚æœºåˆ¶ï¼‰
    
2. GMP æ¨¡å‹çš„æ¨¡æ‹Ÿè°ƒåº¦å›¾ä¸å…·ä½“æ ˆåˆ‡æ¢è¿‡ç¨‹
    
3. Go è°ƒåº¦å™¨çš„æŠ¢å ç‚¹æ’å…¥åŸç†ï¼ˆä» Go 1.14 å¼€å§‹çš„ signal-based æŠ¢å ï¼‰
    
4. `channel` çš„åº•å±‚ç»“æ„åŠ select è¯­ä¹‰
    

æ¬¢è¿æŒ‡å®šæ·±å…¥æ–¹å‘ï¼