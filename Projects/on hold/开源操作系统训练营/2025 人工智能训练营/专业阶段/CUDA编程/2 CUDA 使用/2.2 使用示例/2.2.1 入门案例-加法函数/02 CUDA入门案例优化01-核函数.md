### æ€»ç»“
[01 CUDAä¼˜åŒ– æ ¸å‡½æ•°è°ƒç”¨æ¬¡æ•°](../../2.3%20å¸¸è§é—®é¢˜ä¸ä¼˜åŒ–/2.3.2%20ä¼˜åŒ–/01%20CUDAä¼˜åŒ–%20æ ¸å‡½æ•°è°ƒç”¨æ¬¡æ•°.md)
- ä¼˜åŒ–æ ¸å‡½æ•°è°ƒç”¨æ¬¡æ•°
	- å¤–éƒ¨å¾ªç¯æ”¾åˆ°å†…éƒ¨å¾ªç¯
- HtoD å’Œ DtoH çš„è€—æ—¶å‡è¿œå¤§äºæ ¸å‡½æ•°æ—¶é—´

### ä¼˜åŒ–æ ¸å‡½æ•°
â—†è¿è¡Œæ— è¯¯æå®šï¼ä½†æ˜¯â€¦
â—†å…·ä½“æœ‰å¤šå°‘æå‡å‘¢ï¼Ÿæ¯” CPU å¾ªç¯ç‰ˆæœ¬å¿«äº†å¤šå°‘å‘¢ï¼Ÿ 
â—†CPU ä¸Šè®¡æ—¶æµ‹è¯•ä¸€ä¸‹<<<1,1>>>, <<<256,256>>> å’Œæ»¡è½½çš„æƒ…å†µ 
â—†åœ¨å¤–é¢å¾ªç¯ä¿è¯æ‰€æœ‰æ•°æ®éƒ½è¢«è®¡ç®—

### ä¿®æ”¹åŸæ–‡ä»¶å¹¶åˆ›å»ºæ–°æ–‡ä»¶add_gpu01.cu
ä¸»è¦ä¿®æ”¹éƒ¨åˆ†
```c++
// Kernel

template<typename T>

__global__ void add_kernel(T *c, const T *a, const T *b, size_t n, size_t step) {

Â  Â  int idx = blockIdx.x * blockDim.x + threadIdx.x+step;

Â  Â  if (idx < n) {

Â  Â  Â  Â  c[idx] = a[idx] + b[idx];

Â  Â  }

}

  

template<typename T>

void vector_add(T* c,const T *a, const T *b, size_t n,const dim3& grid,const dim3& block){

Â  Â  size_t step = grid.x * block.x;

Â  Â  for(size_t i =0;i<n;i+=step){

Â  Â  Â  Â  add_kernel<T><<<grid,block>>>(c,a,b,n,i);

Â  Â  }

}
```
è°ƒç”¨éƒ¨åˆ†ä¿®æ”¹
```c++
vector_add( d_c,d_a, d_b,SIZE,grid_dim,block_dim);
```
ç¼–è¯‘è¿è¡Œ
```
nvcc add_gpu/add_gpu01.cu -o target/add_gpu01
```

ä¿®æ”¹ä»¥ä¸‹å†…å®¹æµ‹è¯•æµ‹è¯•ä¸€ä¸‹<<<1,1>>>, <<<256,256>>> å’Œæ»¡è½½çš„æƒ…å†µ
```
Â  Â  dim3 block_dim(256);
Â  Â  dim3 grid_dim(256);
```

### æµ‹è¯•ç»“æœ
![](../../../asserts/Pasted%20image%2020250812142354.png)

### Nsight Systemsï¼ˆCLIï¼‰
>è‹±ä¼Ÿè¾¾çš„ç³»ç»Ÿçº§æ€§èƒ½åˆ†æå·¥å…·

å¯åŠ¨profile
```
nsys profile -t cuda,nvtx,osrt -o target/add_cuda -f true target/add_cuda01
```
è§£æå¹¶ç»Ÿè®¡æ€§èƒ½ä¿¡æ¯
```
nsys stats target/add_cuda.nsys-rep
```

![](../../../asserts/Pasted%20image%2020250812143138.png)
rtx5060å®é™…æµ‹è¯•
256ï¼Œ256ï¼š
cudaMalloc å æ—¶é—´æœ€å¤š
```
 ** CUDA API Summary (cuda_api_sum):

 Time (%)  Total Time (ns)  Num Calls   Avg (ns)   Med (ns)   Min (ns)  Max (ns)   StdDev (ns)           Name         
 --------  ---------------  ---------  ----------  ---------  --------  ---------  -----------  ----------------------
     96.0        196847281          3  65615760.3   510354.0    466268  195870659  112804053.4  cudaMalloc            
      1.8          3713937          4    928484.3   931930.0    644279    1205798     274335.0  cudaMemcpy            
      1.2          2554358          1   2554358.0  2554358.0   2554358    2554358          0.0  cuLibraryLoadData     
      0.5          1028082         16     64255.1     9205.5      6389     887452     219527.8  cudaLaunchKernel      
      0.5           992131          3    330710.3   277755.0    267844     446532     100426.8  cudaFree              
      0.0             3187         16       199.2       95.5        88        995        234.7  cuKernelGetName       
      0.0             1229          1      1229.0     1229.0      1229       1229          0.0  cuLibraryGetKernel    
      0.0              772          1       772.0      772.0       772        772          0.0  cuModuleGetLoadingMode
```
1ï¼Œ1
cudaLaunchKernelå æ—¶é—´æœ€å¤š
```
 ** CUDA API Summary (cuda_api_sum):

 Time (%)  Total Time (ns)  Num Calls   Avg (ns)   Med (ns)   Min (ns)  Max (ns)   StdDev (ns)           Name         
 --------  ---------------  ---------  ----------  ---------  --------  ---------  -----------  ----------------------
     96.6       7820082096    1048576      7457.8     3191.0      2018    6679537      91181.1  cudaLaunchKernel      
      2.7        218200391          3  72733463.7   496794.0    462281  217241316  125147472.4  cudaMalloc            
      0.6         48613773    1048576        46.4       38.0        32    1921024       1900.6  cuKernelGetName       
      0.1          7256763          4   1814190.8  1607557.0    524106    3517543    1516062.7  cudaMemcpy            
      0.0          2540122          1   2540122.0  2540122.0   2540122    2540122          0.0  cuLibraryLoadData     
      0.0          1049373          3    349791.0   292270.0    218992     538111     167154.8  cudaFree              
      0.0             1466          1      1466.0     1466.0      1466       1466          0.0  cuLibraryGetKernel    
      0.0             1187          1      1187.0     1187.0      1187       1187          0.0  cuModuleGetLoadingMode
```


### æ ¸å‡½æ•°è°ƒç”¨æœ‰å¼€é”€ï¼Œåœ¨å¤–é¢å¤šæ¬¡å¾ªç¯è°ƒç”¨å¼€é”€å·¨å¤§
è§£å†³æ–¹æ¡ˆï¼Ÿâ†’ å¾ªç¯æ”¾åœ¨æ ¸å‡½æ•°é‡Œï¼ˆGrid-strided loop)
1ï¼Œ1
```
 ** CUDA API Summary (cuda_api_sum):

 Time (%)  Total Time (ns)  Num Calls   Avg (ns)     Med (ns)    Min (ns)   Max (ns)   StdDev (ns)           Name         
 --------  ---------------  ---------  -----------  -----------  ---------  ---------  -----------  ----------------------
     46.7        228786381          1  228786381.0  228786381.0  228786381  228786381          0.0  cuLibraryLoadData     
     41.8        205160715          3   68386905.0     557815.0     499543  204103357  117533898.8  cudaMalloc            
     10.9         53585604          4   13396401.0     911002.0     572603   51190997   25198065.4  cudaMemcpy            
      0.3          1483351          1    1483351.0    1483351.0    1483351    1483351          0.0  cudaLaunchKernel      
      0.3          1367397          3     455799.0     375415.0     291234     700748     216267.5  cudaFree              
      0.0             1586          1       1586.0       1586.0       1586       1586          0.0  cuModuleGetLoadingMode
      0.0             1092          1       1092.0       1092.0       1092       1092          0.0  cuLibraryGetKernel    
      0.0              793          1        793.0        793.0        793        793          0.0  cuKernelGetName     
```
256
```
 ** CUDA API Summary (cuda_api_sum):

 Time (%)  Total Time (ns)  Num Calls   Avg (ns)   Med (ns)  Min (ns)  Max (ns)   StdDev (ns)           Name         
 --------  ---------------  ---------  ----------  --------  --------  ---------  -----------  ----------------------
     95.8        138549583          3  46183194.3  320233.0    256248  137973102   79492398.3  cudaMalloc            
      3.1          4413043          4   1103260.8  452342.5    399600    3108758    1337443.0  cudaMemcpy            
      0.7           952406          1    952406.0  952406.0    952406     952406          0.0  cuLibraryLoadData     
      0.3           474325          3    158108.3  147377.0    133762     193186      31131.6  cudaFree              
      0.2           295570          1    295570.0  295570.0    295570     295570          0.0  cudaLaunchKernel      
      0.0             1371          1      1371.0    1371.0      1371       1371          0.0  cuModuleGetLoadingMode
      0.0              798          1       798.0     798.0       798        798          0.0  cuLibraryGetKernel    
      0.0              643          1       643.0     643.0       643        643          0.0  cuKernelGetName       

```
åœ¨æ­¤åŸºç¡€ä¸Šä½¿ç”¨float4
```
 ** CUDA API Summary (cuda_api_sum):

 Time (%)  Total Time (ns)  Num Calls   Avg (ns)     Med (ns)    Min (ns)   Max (ns)   StdDev (ns)           Name         
 --------  ---------------  ---------  -----------  -----------  ---------  ---------  -----------  ----------------------
     54.8        217250416          3   72416805.3     594685.0     580479  216075252  124411864.5  cudaMalloc            
     43.8        173575221          1  173575221.0  173575221.0  173575221  173575221          0.0  cuLibraryLoadData     
      0.9          3526801          4     881700.3     850597.5     458470    1367136     468700.0  cudaMemcpy            
      0.3          1038452          3     346150.7     292186.0     266306     479960     116602.5  cudaFree              
      0.2           770081          1     770081.0     770081.0     770081     770081          0.0  cudaLaunchKernel      
      0.0             1578          1       1578.0       1578.0       1578       1578          0.0  cuLibraryGetKernel    
      0.0             1259          1       1259.0       1259.0       1259       1259          0.0  cuKernelGetName       
      0.0              629          1        629.0        629.0        629        629          0.0  cuModuleGetLoadingMode

```

![](../../../asserts/Pasted%20image%2020250812142354.png)
ä¿®æ”¹åï¼š
![](../../../asserts/Pasted%20image%2020250812144534.png)

æŒ‡æ ‡ï¼šåŠ é€Ÿæ¯” = ğ‘»ğ’„ğ’‘ğ’–/ ğ‘»ğ’ˆğ’‘ğ’– 
â—† <<<1,1>>>: ~0.117 
â—† <<<256ï¼Œ256>>>: ~1185.88 
â—† æ»¡è½½: ~1350.81

ä¸ºä»€ä¹ˆï¼Ÿ
å•GPUæ¯ä¸ªçº¿ç¨‹æ¯”cpuå•ä¸ªæ ¸èƒ½åŠ›è¦å¼±
### HtoD å’Œ DtoH çš„è€—æ—¶å‡è¿œå¤§äºæ ¸å‡½æ•°æ—¶é—´ 

![](../../../asserts/Pasted%20image%2020250812144951.png)

è§‚å¯Ÿï¼š 
â—† HtoD å’Œ DtoH çš„è€—æ—¶å‡è¿œå¤§äºæ ¸å‡½æ•°æ—¶é—´ 

æŒ‡æ ‡ï¼šæ€»è€—æ—¶ = ğ‘»ğ‘¯ğŸğ‘« + ğ‘»ğ’Œğ’†ğ’“ğ’ğ’†ğ’ + ğ‘»ğ‘«ğŸğ‘¯

ç–‘é—®ï¼šæœ‰æ¶ˆå‡ H<->D æ—¶é—´çš„æ–¹æ³•å—ï¼Ÿä»€ä¹ˆæ—¶å€™éœ€è¦ä¼˜åŒ–ï¼Ÿ

