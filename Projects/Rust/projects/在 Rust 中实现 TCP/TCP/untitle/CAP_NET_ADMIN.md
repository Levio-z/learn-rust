`CAP_NET_ADMIN`Â æ˜¯ Linux å†…æ ¸ä¸­çš„ä¸€ç§Â **èƒ½åŠ›ï¼ˆCapabilityï¼‰**ï¼Œå®ƒèµ‹äºˆè¿›ç¨‹ç®¡ç†ç½‘ç»œé…ç½®çš„æƒé™ï¼Œå…è®¸æ‰§è¡Œé€šå¸¸éœ€è¦ root æƒé™çš„ç½‘ç»œç›¸å…³æ“ä½œã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†è¯´æ˜ï¼š

---

### **1. æ ¸å¿ƒä½œç”¨**

- **æƒé™èŒƒå›´**ï¼šå…è®¸è¿›ç¨‹æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼ˆæ— éœ€å®Œæ•´ root æƒé™ï¼‰ï¼š
    
    - é…ç½®ç½‘ç»œæ¥å£ï¼ˆå¦‚å¯ç”¨/ç¦ç”¨ã€ä¿®æ”¹ IP åœ°å€ï¼‰ã€‚
        
    - ç®¡ç†é˜²ç«å¢™è§„åˆ™ï¼ˆå¦‚Â `iptables`/`nftables`ï¼‰ã€‚
        
    - ä¿®æ”¹è·¯ç”±è¡¨ã€‚
        
    - **åˆ›å»ºè™šæ‹Ÿç½‘ç»œè®¾å¤‡ï¼ˆå¦‚ TUN/TAPï¼‰ã€‚**
        
    - ç»‘å®šç‰¹æƒç«¯å£ï¼ˆç«¯å£å· < 1024ï¼‰ã€‚
        
- **å…¸å‹ç”¨ä¾‹**ï¼š
    
    - å®¹å™¨ç½‘ç»œç®¡ç†ï¼ˆå¦‚ Dockerã€Kubernetesï¼‰ã€‚
        
    - VPN è½¯ä»¶ï¼ˆå¦‚ OpenVPNã€WireGuardï¼‰ã€‚
        
    - ç½‘ç»œç›‘æ§å·¥å…·ï¼ˆå¦‚ Wireshark éœ€Â `CAP_NET_ADMIN`Â æŠ“åŒ…ï¼‰ã€‚
        

---

### **2. ä¸ Root æƒé™çš„å…³ç³»**

|æ“ä½œ|éœ€ Root æƒé™|éœ€Â `CAP_NET_ADMIN`|
|---|---|---|
|ä¿®æ”¹ IP åœ°å€ (`ip addr`)|æ˜¯|æ˜¯ï¼ˆæ›¿ä»£ï¼‰|
|æŠ“åŒ… (`tcpdump`)|æ˜¯|æ˜¯ï¼ˆæ›¿ä»£ï¼‰|
|æ™®é€š Socket é€šä¿¡|å¦|å¦|

- **ä¼˜åŠ¿**ï¼šé€šè¿‡ç»†ç²’åº¦èƒ½åŠ›åˆ†é…ï¼Œé¿å…è¿›ç¨‹æ‹¥æœ‰ä¸å¿…è¦çš„ root æƒé™ï¼Œæå‡å®‰å…¨æ€§ã€‚
### setcap
### ğŸ“Œ **1ï¸âƒ£ `setcap` å®šä¹‰**

`setcap` æ˜¯ Linux ç³»ç»Ÿä¸‹ç”¨äº**ç»™æ–‡ä»¶ï¼ˆé€šå¸¸æ˜¯å¯æ‰§è¡Œæ–‡ä»¶ï¼‰è®¾ç½® file-based capabilities** çš„å·¥å…·ã€‚  
è¿™äº› capabilityï¼ˆèƒ½åŠ›ï¼‰å±äº Linux **ç»†ç²’åº¦æƒé™æ§åˆ¶æœºåˆ¶**ï¼Œæ˜¯æ¯” `root` æ›´ç²¾ç»†çš„ç‰¹æƒåˆ†ç¦»ã€‚

ä¾‹å¦‚ï¼š

- `cap_net_admin` â†’ å…è®¸ç¨‹åºç®¡ç†ç½‘ç»œè®¾å¤‡ï¼ˆå¦‚ TUN/TAPï¼‰ã€‚
    
- `cap_sys_time` â†’ å…è®¸ç¨‹åºä¿®æ”¹ç³»ç»Ÿæ—¶é—´ã€‚
    
- `cap_dac_override` â†’ ç»•è¿‡æ–‡ä»¶è¯»å†™æƒé™æ£€æŸ¥ã€‚
    

è¿™äº›èƒ½åŠ›æ¥è‡ª Linux å†…æ ¸çš„ `capabilities(7)` ç³»ç»Ÿã€‚

---

### ğŸ“Œ **2ï¸âƒ£ å¸¸ç”¨å‚æ•°è¯¦è§£**

|å‚æ•°|å«ä¹‰|
|---|---|
|`-q`|é™é»˜æ¨¡å¼ï¼Œä¸è¾“å‡ºå†—ä½™ä¿¡æ¯ã€‚|
|`-v`|éªŒè¯æ–‡ä»¶å½“å‰å·²è®¾ç½®çš„ capability æ˜¯å¦ä¸ç»™å®šå‚æ•°åŒ¹é…ï¼ˆè€Œä¸æ˜¯ä¿®æ”¹å®ƒï¼‰ã€‚|
|`-n <rootuid>`|æŒ‡å®šä¸€ä¸ª user namespace ä¸­çš„ root ç”¨æˆ· IDï¼Œç”¨äº namespace å†…çš„ç‰¹å®š capability è®¾ç½®æˆ–éªŒè¯ã€‚|
|`<capabilities>`|èƒ½åŠ›å­—ç¬¦ä¸²ï¼Œç”¨ `cap_from_text(3)` æ ¼å¼ï¼Œä¾‹å¦‚ `cap_net_admin=+ep`ã€‚|
|`-r`|ç§»é™¤æ–‡ä»¶çš„ capability é›†ï¼ˆ**æ³¨æ„**ï¼šè¿™ä¸åŒäºè®¾ç½®ç©ºé›†ï¼Œç§»é™¤æ˜¯å½»åº•æ¸…é™¤ metadataï¼‰ã€‚|
|`-`ï¼ˆå•ç‹¬ä¸€ä¸ªå‡å·ï¼‰|ä»æ ‡å‡†è¾“å…¥ä¸­è¯»å– capability è®¾ç½®ï¼Œç›´åˆ°é‡åˆ°ç©ºè¡Œã€‚|

---

### ğŸ“Œ **3ï¸âƒ£ èƒ½åŠ›å­—ç¬¦ä¸²æ ¼å¼**

å®˜æ–¹è°ƒç”¨ `cap_from_text(3)`ï¼Œé€šå¸¸æ ¼å¼ï¼š

php-template

å¤åˆ¶ç¼–è¾‘

`<capability_name>=<flag>`

- `<capability_name>`ï¼šæ¯”å¦‚ `cap_net_admin`ã€‚
    
- `<flag>`ï¼š
    
    - `+ep` â†’ effective + permittedã€‚
        
    - `+eip` â†’ effective + inherited + permittedã€‚
        
    - `-ep` â†’ ä» effective å’Œ permitted ä¸­ç§»é™¤ã€‚
        

ä¾‹å­ï¼š

bash

å¤åˆ¶ç¼–è¾‘

`sudo setcap cap_net_admin=+ep ./tcp_rust`

å®ƒç»™ `./tcp_rust` è¿™ä¸ª ELF æ–‡ä»¶èµ‹äºˆï¼š

- `cap_net_admin` èƒ½åŠ›ï¼Œ
    
- åœ¨è¿è¡Œæ—¶ç”Ÿæ•ˆï¼ˆeffectiveï¼‰ï¼Œ
    
- å±äºè¿›ç¨‹å…è®¸ï¼ˆpermittedï¼‰é›†ã€‚
    

---

### ğŸ“Œ **4ï¸âƒ£ ä½¿ç”¨åœºæ™¯**

|åœºæ™¯|æ˜¯å¦ç”¨ `setcap`|
|---|---|
|Rust ç¨‹åºä¸­ç›´æ¥æ“ä½œ TUN è®¾å¤‡ï¼Œæ— éœ€ sudo|âœ… ç”¨ `cap_net_admin=+ep`|
|Go ç¼–å†™çš„ç«¯å£ç»‘å®šç¨‹åºï¼ˆ<1024ï¼‰ä¸æƒ³ sudo å¯åŠ¨|âœ… ç”¨ `cap_net_bind_service=+ep`|
|Python è„šæœ¬è®¿é—®è£¸å—è®¾å¤‡|âœ… ç”¨ `cap_sys_rawio=+ep`|
|Docker å®¹å™¨é‡Œé™åˆ¶å®¹å™¨èƒ½ç”¨çš„å†…æ ¸èƒ½åŠ›|âŒ éœ€è¦ `docker run --cap-add`ï¼Œä¸ç›´æ¥ç”¨ `setcap`|
|ç¨‹åºéœ€è¦ root å®Œå…¨æ§åˆ¶æƒ|âŒ ç›´æ¥ç”¨ rootï¼Œä¸ç”¨ capabilities|

---

### ğŸ“Œ **5ï¸âƒ£ å†…æ ¸æœºåˆ¶ä¸åŸç†**

Linux å†…æ ¸ä¸ºè¿›ç¨‹è®¾è®¡äº† 3 ç§ä¸»è¦çš„ capability é›†ï¼š

1. **Effective** â†’ å½“å‰ç”Ÿæ•ˆçš„ã€‚
    
2. **Permitted** â†’ å…è®¸æå‡åˆ° effectiveã€‚
    
3. **Inheritable** â†’ å¯ç»§æ‰¿åˆ°å­è¿›ç¨‹ã€‚
    

`setcap` å®é™…ä¸Šæ˜¯ä¿®æ”¹æ–‡ä»¶ç³»ç»Ÿä¸­çš„ **extended attributesï¼ˆxattrï¼‰**ï¼š

- å­˜åœ¨ `security.capability` å±æ€§ã€‚
    
- å¯ç”¨ `getfattr` æ£€æŸ¥ï¼š
    
    bash
    
    å¤åˆ¶ç¼–è¾‘
    
    `getfattr -n security.capability ./tcp_rust`
    

**âš  æ³¨æ„ï¼š**

- åªæœ‰æ”¯æŒ xattr çš„æ–‡ä»¶ç³»ç»Ÿï¼ˆå¦‚ ext4ã€xfsï¼‰æ‰èƒ½ä¿å­˜è¿™äº›å±æ€§ã€‚
    
- FAT32ã€tmpfs ç­‰æ–‡ä»¶ç³»ç»Ÿæ— æ³•ä¿å­˜ï¼Œä¼šæŠ¥é”™ã€‚
    

---

### ğŸ“Œ **6ï¸âƒ£ æºç å…¥å£ä¸æ‰©å±•çŸ¥è¯†**

- **æºç ä½ç½®ï¼š**
    
    - `libcap` å·¥å…·é›† â†’ https://git.kernel.org/pub/scm/libs/libcap/libcap.git
        
    - ä¸»è¦æ–‡ä»¶ï¼š`progs/setcap.c`
        
- **ç³»ç»Ÿè°ƒç”¨é“¾ï¼š**
    
    - `setcap` â†’ ä¿®æ”¹ `security.capability` â†’ å†…æ ¸ `vfs_setxattr` â†’ å†…æ ¸å®‰å…¨æ¨¡å—ï¼ˆLSMï¼‰æ£€æµ‹ã€‚
        
- **æ‰©å±•çŸ¥è¯†ç‚¹ï¼š**
    
    - capabilities æœºåˆ¶æ˜¯ Linux ä¸ºäº†é¿å… â€œä¸€åˆ€åˆ‡ rootâ€ è®¾è®¡çš„ç»†ç²’åº¦æƒé™åˆ†ç¦»ã€‚
        
    - ä¸ seccompï¼ˆç³»ç»Ÿè°ƒç”¨è¿‡æ»¤ï¼‰ã€AppArmorã€SELinux æ­é…å¯æ„å»ºå¤æ‚å®‰å…¨ç­–ç•¥ã€‚
        
    - ç»“åˆ Rust FFIã€raw syscallï¼Œä½ ç”šè‡³å¯ä»¥ç›´æ¥ç”¨ `prctl()` åœ¨è¿è¡Œæ—¶æŸ¥è¯¢æˆ–ä¿®æ”¹è¿›ç¨‹ capabilitiesã€‚
        

---

### ğŸ›  å°å¹½é»˜æ€»ç»“

> `setcap` å°±åƒç»™ Rust ç¨‹åºæˆ´ä¸Šä¸€é¡¶â€œç‰¹æƒå°çš‡å† â€ï¼Œè®©å®ƒ **éƒ¨åˆ† root**ï¼Œä¸å¿…å…¨ rootã€‚æˆ´å¥½äº†ï¼ŒæƒåŠ›æœ‰é™ï¼›æˆ´æ­ªäº†ï¼Œè¿˜æ˜¯å¾—ç”¨ sudo å–Šçˆ¸çˆ¸ã€‚

---

å¦‚æœä½ éœ€è¦ï¼š  
âœ… ä¸€æ®µ Rust ä»£ç ï¼ŒæŸ¥è¯¢æˆ–ä½¿ç”¨å½“å‰è¿›ç¨‹çš„ capabilitiesï¼›  
âœ… ä¸€ä¸ª bash è„šæœ¬ï¼Œæ‰¹é‡æ£€æµ‹æ–‡ä»¶ capabilitiesï¼›  
âœ… å¸®ä½ å†™ä¸ª Rust å°æ¨¡å—ï¼Œç›´æ¥ç”¨ `ioctl` é©±åŠ¨ TUN è®¾å¤‡ï¼›

ç›´æ¥è¯´ï¼Œæˆ‘å¯ä»¥ç»™ä½ é‡èº«å®šåˆ¶ï¼è¦æ¥ä¸€å‘å—ï¼ŸğŸ˜„