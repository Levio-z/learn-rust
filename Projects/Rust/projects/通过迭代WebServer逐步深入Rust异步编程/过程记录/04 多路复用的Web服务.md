ç°åœ¨æˆ‘ä»¬çš„ Web æœåŠ¡èƒ½åœ¨å•çº¿ç¨‹ä¸­æ‰§è¡Œå¤šä¸ªè¯·æ±‚ï¼Œæ²¡æœ‰ä»»ä½•é˜»å¡ã€‚å¦‚æœæŸä¸ªæ“ä½œè¢«é˜»å¡ï¼Œå®ƒå°†è®°ä½è‡ªå·±çš„çŠ¶æ€å¹¶åˆ‡æ¢ï¼Œè®©å…¶ä»–æ“ä½œæ‰§è¡Œï¼Œè¿™è·Ÿå†…æ ¸è°ƒåº¦å™¨çš„è¡Œä¸ºä¸€è‡´ã€‚ä½†æ˜¯ï¼Œæ–°è®¾è®¡å¸¦æ¥äº†ä¸¤ä¸ªé—®é¢˜.

é¦–å…ˆæ˜¯**æ‰€æœ‰çš„å·¥ä½œéƒ½åœ¨ä¸»çº¿ç¨‹ä¸­è¿è¡Œï¼Œåªåˆ©ç”¨äº†ä¸€ä¸ª CPU æ ¸å¿ƒ**ã€‚æˆ‘ä»¬å°½æœ€å¤§åŠªåŠ›é«˜æ•ˆåœ°åˆ©ç”¨è¿™ä¸€æ ¸å¿ƒï¼Œä½†ä¸€æ¬¡ä»ç„¶åªæ‰§è¡Œä¸€ä¸ªä»»åŠ¡ã€‚å¦‚æœçº¿ç¨‹èƒ½åˆ†å¸ƒåœ¨å¤šä¸ªæ ¸å¿ƒä¸Šï¼Œæˆ‘ä»¬åŒä¸€æ—¶é—´å°±å¯ä»¥åšæ›´å¤šçš„å·¥ä½œã€‚
ä¸è¿‡æœ‰ä¸€ä¸ªæ›´å¤§çš„é—®é¢˜ã€‚

æˆ‘ä»¬çš„ä¸»å¾ªç¯æ•ˆç‡å¹¶ä¸é«˜ã€‚
**æˆ‘ä»¬å¯¹æ¯ä¸€ä¸ªæ´»è·ƒçš„è¿æ¥ï¼Œæ¯ä¸€æ¬¡å¾ªç¯çš„è¿­ä»£ï¼Œéƒ½è¦å‘å†…æ ¸å‘å‡ºä¸€ä¸ª I/O è¯·æ±‚ï¼Œæ¥æ£€æŸ¥å®ƒæ˜¯å¦å‡†å¤‡å¥½äº†ã€‚å³ä½¿è°ƒç”¨ read æˆ– write è¿”å›äº† WouldBlockï¼Œå®é™…æ²¡æœ‰æ‰§è¡Œä»»ä½• I/Oï¼Œå®ƒä»ç„¶æ˜¯ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨ã€‚ç³»ç»Ÿè°ƒç”¨å¹¶ä¸ä¾¿å®œ**ã€‚æˆ‘ä»¬å¯èƒ½æœ‰ 10k ä¸ªæ´»è·ƒçš„è¿æ¥ï¼Œä½†åªæœ‰ 500 ä¸ªæ˜¯å‡†å¤‡å¥½çš„ã€‚å½“åªæœ‰ 500 ä¸ªè¿æ¥ä¼šçœŸæ­£åšäº›äº‹æƒ…çš„æ—¶å€™ï¼Œè°ƒç”¨ read æˆ– write 10k æ¬¡æ˜¯å¯¹ CPU å‘¨æœŸçš„å·¨å¤§æµªè´¹ã€‚

éšç€è¿æ¥æ•°çš„å¢åŠ ï¼Œæˆ‘ä»¬çš„å¾ªç¯å˜å¾—è¶Šæ¥è¶Šä½æ•ˆï¼Œæµªè´¹äº†æ›´å¤šçš„æ—¶é—´åšæ— ç”¨çš„å·¥ä½œã€‚

æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿä½¿ç”¨é˜»å¡ I/O æ—¶ï¼Œå†…æ ¸èƒ½å¤Ÿæœ‰æ•ˆåœ°è°ƒåº¦ä»»åŠ¡ï¼Œå› ä¸ºå®ƒçŸ¥é“èµ„æºä»€ä¹ˆæ—¶å€™å‡†å¤‡å¥½äº†ã€‚ä½¿ç”¨éé˜»å¡ I/O æ—¶ï¼Œæˆ‘ä»¬ä¸æ£€æŸ¥å°±ä¸çŸ¥é“ï¼Œä½†æ˜¯æ£€æŸ¥æ˜¯å¾ˆæ˜‚è´µçš„ã€‚

æˆ‘ä»¬éœ€è¦çš„æ˜¯ä¸€ç§é«˜æ•ˆçš„æ–¹å¼æ¥è·Ÿè¸ªæ‰€æœ‰çš„æ´»è·ƒè¿æ¥ï¼Œå¹¶ä¸”åœ¨å®ƒä»¬å‡†å¤‡å¥½çš„æ—¶å€™å¾—åˆ°é€šçŸ¥ã€‚

äº‹å®è¯æ˜ï¼Œæˆ‘ä»¬å¹¶ä¸æ˜¯ç¬¬ä¸€ä¸ªé‡åˆ°è¿™ä¸ªé—®é¢˜çš„äººã€‚æ¯ä¸ªæ“ä½œç³»ç»Ÿéƒ½æä¾›äº†é’ˆå¯¹è¿™ä¸ªé—®é¢˜çš„è§£å†³æ–¹æ¡ˆã€‚åœ¨ Linux ä¸Šï¼Œå®ƒå«åš epollã€‚

epoll(7) - I/O äº‹ä»¶é€šçŸ¥æœºåˆ¶

epoll API æ‰§è¡Œçš„ä»»åŠ¡ä¸ poll(2) ç±»ä¼¼ï¼šç›‘è§†å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œçœ‹çœ‹æ˜¯å¦æœ‰ä»»ä½•ä¸€ä¸ªå¯ä»¥è¿›è¡Œ I/O æ“ä½œã€‚epoll API å¯ä»¥ä½œä¸ºè¾¹ç¼˜è§¦å‘ï¼ˆedge-triggeredï¼‰æˆ–æ°´å¹³è§¦å‘ï¼ˆlevel-triggeredï¼‰çš„æ¥å£ä½¿ç”¨ï¼Œå¹¶ä¸”èƒ½å¤Ÿå¾ˆå¥½åœ°æ‰©å±•åˆ°ç›‘è§†å¤§é‡çš„æ–‡ä»¶æè¿°ç¬¦ã€‚

å¬ä¸Šå»å¾ˆå®Œç¾ï¼æˆ‘ä»¬è¯•è¯•çœ‹ã€‚

epoll æ˜¯ä¸€ç»„ Linux ç³»ç»Ÿè°ƒç”¨ï¼Œ**è®©æˆ‘ä»¬å¯ä»¥å¤„ç†ä¸€ç»„éé˜»å¡çš„å¥—æ¥å­—ã€‚ç›´æ¥ä½¿ç”¨ epoll å¹¶ä¸æ˜¯å¾ˆæ–¹ä¾¿ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†ä½¿ç”¨ epoll crateï¼Œå®ƒæ˜¯ä¸€ä¸ªå¯¹ C æ¥å£çš„è½»åº¦å°è£…ã€‚**

é¦–å…ˆï¼Œæˆ‘ä»¬ä½¿ç”¨ create å‡½æ•°æ¥åˆå§‹åŒ–ä¸€ä¸ª epoll å®ä¾‹ã€‚

```rust
// ```toml
// [dependencies]
// epoll = "4.3"
// ```

fn main() {
    let epoll = epoll::create(false).unwrap(); // ğŸ‘ˆ
}


```
epoll::create è¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œå®ƒä»£è¡¨äº†æ–°åˆ›å»ºçš„ epoll å®ä¾‹ã€‚ä½ å¯ä»¥æŠŠå®ƒçœ‹ä½œæ˜¯ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦çš„é›†åˆï¼Œæˆ‘ä»¬å¯ä»¥ä»ä¸­æ·»åŠ æˆ–åˆ é™¤æ–‡ä»¶æè¿°ç¬¦ã€‚

åœ¨ Linux/Unix ä¸­ï¼Œä¸€åˆ‡éƒ½è¢«è§†ä¸ºæ–‡ä»¶ã€‚æ–‡ä»¶ç³»ç»Ÿä¸Šçš„å®é™…æ–‡ä»¶ã€TCP å¥—æ¥å­—ã€ä»¥åŠå¤–éƒ¨è®¾å¤‡éƒ½æ˜¯å¯ä»¥è¯»å†™çš„æ–‡ä»¶ã€‚æ–‡ä»¶æè¿°ç¬¦æ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œå®ƒè¡¨ç¤ºç³»ç»Ÿä¸­æ‰“å¼€çš„â€œæ–‡ä»¶â€ã€‚æœ¬æ–‡æ¥ä¸‹æ¥çš„éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†é¢‘ç¹ä½¿ç”¨å®ƒã€‚

æˆ‘ä»¬è¦æ·»åŠ çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦æ˜¯ TCP ç›‘å¬å™¨ã€‚å¯ä»¥ç”¨ epoll::ctl å‘½ä»¤æ¥ä¿®æ”¹ epoll é›†åˆï¼Œæ·»åŠ æ–‡ä»¶æè¿°ç¬¦ä½¿ç”¨EPOLL_CTL_ADDæ ‡å¿—ã€‚

```rust
use epoll::{Event, Events, ControlOptions::*};
use std::os::fd::AsRawFd;

fn main() {
    let listener = TcpListener::bind("localhost:3000").unwrap();
    listener.set_nonblocking(true).unwrap();

    // æ·»åŠ  listener åˆ° epoll
    let event = Event::new(Events::EPOLLIN, listener.as_raw_fd() as _);
    epoll::ctl(epoll, EPOLL_CTL_ADD, listener.as_raw_fd(), event).unwrap(); // ğŸ‘ˆ
}


```
æˆ‘ä»¬ä¼ å…¥è¦æ³¨å†Œçš„èµ„æºçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä¹Ÿå°±æ˜¯ TCP ç›‘å¬å™¨ï¼Œä»¥åŠä¸€ä¸ªäº‹ä»¶ã€‚ä¸€ä¸ªäº‹ä»¶æœ‰ä¸¤ä¸ªéƒ¨åˆ†ï¼Œinterest flag å’Œ data fieldã€‚interest flag è®©æˆ‘ä»¬å¯ä»¥å‘Šè¯‰ epoll æˆ‘ä»¬æ„Ÿå…´è¶£çš„ I/O äº‹ä»¶ã€‚åœ¨ TCP ç›‘å¬å™¨ä¸­ï¼Œæˆ‘ä»¬æƒ³è¦åœ¨æœ‰æ–°è¿æ¥è¿›æ¥æ—¶å¾—åˆ°é€šçŸ¥ï¼Œæ‰€ä»¥ä¼ å…¥ EPOLLIN æ ‡å¿—ã€‚
- `Events::EPOLLIN`  
    è¡¨ç¤ºä½ å…³æ³¨çš„æ˜¯**å¯è¯»äº‹ä»¶**ï¼ˆå³â€œæœ‰æ•°æ®å¯è¯»â€æˆ–â€œæœ‰æ–°è¿æ¥â€ï¼‰ã€‚
- `as u64`  
    epoll çš„äº‹ä»¶ç»“æ„ä½“é‡Œæœ‰ä¸€ä¸ªÂ `data`Â å­—æ®µï¼ˆç±»å‹æ˜¯Â `u64`ï¼‰ï¼Œä½ å¯ä»¥å­˜ä»»ä½•ä½ æƒ³æºå¸¦çš„ä¿¡æ¯ï¼Œé€šå¸¸å­˜ fd ä»¥ä¾¿è¯†åˆ«äº‹ä»¶å¯¹åº”çš„ socketã€‚
	- epoll æ¯æ¬¡è¿”å›äº‹ä»¶æ—¶ï¼Œåªå‘Šè¯‰ä½ â€œå“ªä¸ªäº‹ä»¶å‘ç”Ÿäº†â€ï¼Œä½ è‡ªå·±éœ€è¦æ ¹æ®Â `data`Â å­—æ®µåˆ¤æ–­æ˜¯å“ªä¸ª fd æˆ–å“ªä¸ªè¿æ¥ã€‚
	- é€šå¸¸ç”¨ fd ä½œä¸ºÂ `data`ï¼Œåç»­æ ¹æ® fd æ‰¾åˆ°å¯¹åº”è¿æ¥æˆ–æ•°æ®ç»“æ„ã€‚
data field è®©æˆ‘ä»¬å¯ä»¥å­˜å‚¨ä¸€ä¸ªèƒ½å¤Ÿå”¯ä¸€æ ‡è¯†æ¯ä¸ªèµ„æºçš„ IDã€‚è®°ä½ï¼Œæ–‡ä»¶æè¿°ç¬¦æ˜¯ä¸€ä¸ªç»™å®šæ–‡ä»¶çš„å”¯ä¸€æ•´æ•°ï¼Œæ‰€ä»¥ç›´æ¥ä½¿ç”¨å®ƒã€‚ä½ ä¼šåœ¨ä¸‹ä¸€æ­¥çœ‹åˆ°ä¸ºä»€ä¹ˆè¿™å¾ˆé‡è¦ã€‚
ç°åœ¨è½®åˆ°ä¸»å¾ªç¯ã€‚è¿™æ¬¡ä¸ç”¨è‡ªæ—‹ï¼Œç”¨ epoll::waitã€‚

epoll_wait(2) - ç­‰å¾… epoll æ–‡ä»¶æè¿°ç¬¦ä¸Šçš„ I/O äº‹ä»¶

**å¯¹æ–‡ä»¶æè¿°ç¬¦ epfd æŒ‡å‘çš„ epoll(7) å®ä¾‹è€Œè¨€ï¼Œepoll_wait() ç³»ç»Ÿè°ƒç”¨ä¼šç­‰å¾…å…¶ä¸Šçš„äº‹ä»¶ã€‚interest list ä¸­çš„æ–‡ä»¶æè¿°ç¬¦æŒ‡å‘çš„ ready list ä¸­ï¼Œå¦‚æœæœ‰ä¸€äº›å¯ç”¨äº‹ä»¶çš„ä¿¡æ¯ï¼Œé‚£ä¹ˆè¿™äº›ä¿¡æ¯é€šè¿‡ events æŒ‡å‘çš„ç¼“å†²åŒºè¿”å›ã€‚**

è°ƒç”¨ epoll_wait() å°†é˜»å¡ï¼Œç›´åˆ°ä»¥ä¸‹ä»»ä¸€æƒ…å†µå‘ç”Ÿï¼š

- æ–‡ä»¶æè¿°ç¬¦æäº¤äº†ä¸€ä¸ªäº‹ä»¶ï¼›
- è°ƒç”¨è¢«ä¿¡å·å¤„ç†å™¨ä¸­æ–­ï¼›
- è¶…æ—¶ï¼›

epoll::wait æ˜¯ epoll çš„ç¥å¥‡ä¹‹å¤„ï¼š**å®ƒé˜»å¡ç›´åˆ°æˆ‘ä»¬æ³¨å†Œçš„ä»»ä½•äº‹ä»¶å˜å¾—å°±ç»ªï¼Œå¹¶å‘Šè¯‰æˆ‘ä»¬å“ªäº›äº‹ä»¶å°±ç»ªäº†ã€‚æ­¤æ—¶è¿™ä»…ç”¨äºæœ‰æ–°è¿æ¥è¿›æ¥æ—¶ï¼Œä½†æ˜¯å¾ˆå¿«æˆ‘ä»¬å°†ä½¿ç”¨å®ƒæ¥é˜»å¡è¯»ã€å†™å’Œåˆ·æ–°äº‹ä»¶ï¼Œè¿™äº›äº‹ä»¶æˆ‘ä»¬ä¹‹å‰æ˜¯ç”¨è‡ªæ—‹çš„æ–¹å¼å¤„ç†çš„ã€‚**

æ‚¨å¯èƒ½ä¸å–œæ¬¢ epoll::wait æ˜¯â€œé˜»å¡â€çš„è¿™ä¸€äº‹å®ï¼Œä½†æ˜¯ï¼Œå®ƒåªåœ¨æ²¡æœ‰ä»»ä½•äº‹æƒ…å¯åšçš„æ—¶å€™æ‰é˜»å¡ï¼Œè€Œä¹‹å‰æˆ‘ä»¬æ˜¯åœ¨è‡ªæ—‹å¹¶ä¸”åšæ— ç”¨çš„ç³»ç»Ÿè°ƒç”¨ã€‚è¿™ç§åŒæ—¶é˜»å¡å¤šä¸ªæ“ä½œçš„æ–¹æ³•è¢«ç§°ä¸ºÂ _I/O å¤šè·¯å¤ç”¨_ã€‚

**epoll::wait æ¥å—ä¸€ä¸ªäº‹ä»¶çš„åˆ—è¡¨ï¼Œå½“æ‰€å…³æ³¨çš„æ–‡ä»¶æè¿°ç¬¦å°±ç»ªï¼Œå®ƒä¼šå°†æ–‡ä»¶æè¿°ç¬¦çš„ä¿¡æ¯å¡«å……åˆ°åˆ—è¡¨ï¼Œç„¶åè¿”å›è¢«æ·»åŠ çš„äº‹ä»¶çš„æ•°é‡ã€‚**
```rust
// ...
loop {
    let mut events = [Event::new(Events::empty(), 0); 1024];
    let timeout = -1; // é˜»å¡ï¼Œç›´åˆ°æŸäº›äº‹æƒ…å‘ç”Ÿ
    let num_events = epoll::wait(epoll, timeout, &mut events).unwrap(); // ğŸ‘ˆ

    for event in &events[..num_events] {
        // ...
    }
}


```
epoll::wait è¡Œä¸ºè§£é‡Š
- `epoll::wait(epoll, timeout, &mut events)`Â çš„ä½œç”¨æ˜¯ï¼š
    - ç­‰å¾… epoll å®ä¾‹Â `epoll`Â ä¸Šæ³¨å†Œçš„æ–‡ä»¶æè¿°ç¬¦ï¼ˆfdï¼‰æœ‰äº‹ä»¶å‘ç”Ÿã€‚
    - å½“æœ‰ fd å°±ç»ªæ—¶ï¼Œ**æŠŠè¿™äº›å°±ç»ªäº‹ä»¶çš„è¯¦ç»†ä¿¡æ¯**å¡«å…¥Â `events`Â æ•°ç»„ï¼ˆä½ è¿™é‡Œæ˜¯é•¿åº¦ 1024 çš„æ•°ç»„ï¼‰ã€‚
    - è¿”å›å€¼Â `num_events`Â æ˜¯**æœ¬æ¬¡è¢«è§¦å‘çš„äº‹ä»¶ä¸ªæ•°**ã€‚
å‚æ•°è¯¦è§£
- `epoll`ï¼šepoll å®ä¾‹çš„å¥æŸ„ï¼ˆfdï¼‰ã€‚
- `timeout`ï¼šÂ Â `è¶…æ—¶` ï¼š
    - `-1`Â è¡¨ç¤º**ä¸€ç›´é˜»å¡**ï¼Œç›´åˆ°æœ‰äº‹ä»¶å‘ç”Ÿã€‚
    - `0`Â è¡¨ç¤º**ç«‹å³è¿”å›**ï¼Œä¸ä¼šé˜»å¡ï¼ˆå³â€œè½®è¯¢â€ï¼‰ã€‚
    - `>0`Â è¡¨ç¤º**ç­‰å¾…æŒ‡å®šæ¯«ç§’æ•°**ï¼Œè¶…æ—¶åå°±ç®—æ²¡äº‹ä»¶ä¹Ÿä¼šè¿”å›ã€‚
- `&mut events`ï¼šç”¨äºæ¥æ”¶äº‹ä»¶çš„æ•°ç»„ã€‚
äº‹ä»¶æ•°ç»„
- æ¯ä¸ªÂ `Event`Â ç»“æ„ä½“åŒ…å«äº†ï¼š
    - å°±ç»ªçš„äº‹ä»¶ç±»å‹ï¼ˆå¯è¯»ã€å¯å†™ã€å¼‚å¸¸ç­‰ï¼‰
    - ä½ æ³¨å†Œæ—¶å¡«è¿›å»çš„Â `data`Â å­—æ®µï¼ˆé€šå¸¸æ˜¯ fd æˆ–è€…ä½ çš„è‡ªå®šä¹‰æ•°æ®ï¼‰
æ¯ä¸ªäº‹ä»¶éƒ½åŒ…å«æ•°æ®å­—æ®µï¼Œè¯¥å­—æ®µä¸å°±ç»ªçš„èµ„æºç›¸å…³è”ã€‚
```rust
for event in &events[..num_events] {
    let fd = event.data as i32;
    // ...
}

```
è¿˜è®°å¾—æˆ‘ä»¬ç”¨æ–‡ä»¶æè¿°ç¬¦æ¥æ ‡è®°æ•°æ®å­—æ®µå—ï¼Ÿæˆ‘ä»¬å¯ä»¥ç”¨å®ƒæ¥æ£€æŸ¥äº‹ä»¶æ˜¯å¦æ˜¯é’ˆå¯¹TCPç›‘å¬å™¨çš„ï¼Œå¦‚æœæ˜¯ï¼Œé‚£å°±æ„å‘³ç€æœ‰ä¸€ä¸ªä¼ å…¥è¿æ¥å·²ç»å‡†å¤‡å¥½è¢«æ¥å—äº†ã€‚
```rust
for event in &events[..num_events] {
    let fd = event.data as i32;

    // listenerå‡†å¤‡å°±ç»ªäº†å—?
    if fd == listener.as_raw_fd() {
        // å°è¯•å»ºç«‹ä¸€ä¸ªè¿æ¥
        match listener.accept() {
            Ok((connection, _)) => {
                connection.set_nonblocking(true).unwrap();

                // ...
            }
            Err(e) if e.kind() == io::ErrorKind::WouldBlock => {}
            Err(e) => panic!("{e}"),
        }
    }
}

```
å¦‚æœè¿”å› WouldBlockï¼Œ åˆ™ç§»åŠ¨åˆ°ä¸‹ä¸€ä¸ªè¿æ¥ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡äº‹ä»¶å‘ç”Ÿã€‚

ç°åœ¨éœ€è¦åœ¨ epoll ä¸­æ³¨å†Œæ–°çš„è¿æ¥ï¼Œè·Ÿæ³¨å†Œä¾¦å¬å™¨ä¸€æ ·ã€‚
```rust
for event in &events[..num_events] {
    let fd = event.data as i32;

    // listenerå‡†å¤‡å°±ç»ªäº†å—?
    if fd == listener.as_raw_fd() {
        // å°è¯•å»ºç«‹ä¸€ä¸ªè¿æ¥
        match listener.accept() {
            Ok((connection, _)) => {
                connection.set_nonblocking(true).unwrap();
                 let fd = connection.as_raw_fd();

                 // æ³¨å†Œæ–°è¿æ¥åˆ°epoll
                 let event = Event::new(Events::EPOLLIN | Events::EPOLLOUT, fd as _);
                 epoll::ctl(epoll, EPOLL_CTL_ADD, fd, event).unwrap(); // ğŸ‘ˆ
            }
            Err(e) if e.kind() == io::ErrorKind::WouldBlock => {}
            Err(e) => panic!("{e}"),
        }
    }
}

```
è¿™æ¬¡æˆ‘ä»¬æ³¨å†Œäº†EPOLLIN å’Œ EPOLLOUT äº‹ä»¶ï¼Œå› ä¸ºæ ¹æ®è¿æ¥çŠ¶æ€ï¼Œæˆ‘ä»¬è¦å…³æ³¨è¯»æˆ–å†™äº‹ä»¶ã€‚

æ³¨å†Œäº†è¿æ¥ä¹‹åï¼Œæˆ‘ä»¬å°†å¾—åˆ° TCP ä¾¦å¬å™¨å’ŒæŸä¸ªè¿æ¥çš„äº‹ä»¶ã€‚æˆ‘ä»¬éœ€è¦ç”¨æŸç§æ–¹å¼å­˜å‚¨è¿æ¥å’Œå®ƒä»¬çš„çŠ¶æ€ï¼Œå¹¶èƒ½é€šè¿‡æŸ¥æ‰¾æ–‡ä»¶æè¿°ç¬¦çš„æ–¹å¼æ¥è®¿é—®å®ƒä»¬ã€‚

è¿™æ¬¡ä¸ç”¨ Listï¼Œç”¨ HashMapã€‚
```rust
let mut connections = HashMap::new();

loop {
    // ...
    'next: for event in &events[..num_events] {
        let fd = event.data as i32;

        // listenerå‡†å¤‡å°±ç»ªäº†å—?
        if fd == listener.as_raw_fd() {
            match listener.accept() {
                Ok((connection, _)) => {
                    // ...

                    let state = ConnectionState::Read {
                        request: [0u8; 1024],
                        read: 0,
                    };

                    connections.insert(fd, (connection, state)); // ğŸ‘ˆ
                }
                Err(e) if e.kind() == io::ErrorKind::WouldBlock => {}
                Err(e) => panic!("{e}"),
            }

            continue 'next;
        }

        // listeneræœªå°±ç»ªçš„è¯ï¼Œå¿…é¡»æœ‰è¿æ¥æ˜¯å°±ç»ªçš„
        let (connection, state) = connections.get_mut(&fd).unwrap(); // ğŸ‘ˆ
    }
}

```
ä¸€æ—¦è¿æ¥å’Œå®ƒçš„çŠ¶æ€å°±ç»ªï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å’Œä¹‹å‰ä¸€æ ·çš„æ–¹æ³•æ¥æ¨è¿›å®ƒã€‚**ä»æµä¸­è¯»å†™æ•°æ®çš„æ“ä½œæ²¡æœ‰ä»»ä½•å˜åŒ–ï¼ŒåŒºåˆ«æ˜¯ç°åœ¨æˆ‘ä»¬ä»…åœ¨æ¥åˆ° epoll é€šçŸ¥æ—¶æ‰è¿›è¡Œæ“ä½œã€‚**
- é€šå¸¸åœ¨ epoll äº‹ä»¶å¾ªç¯ä¸­ï¼Œå½“æŸä¸ª fdï¼ˆä¸æ˜¯ listenerï¼Œè€Œæ˜¯å·²å»ºç«‹è¿æ¥çš„ fdï¼‰æœ‰äº‹ä»¶æ—¶ï¼Œä»Â `connections`Â å–å‡ºå¯¹åº”çš„è¿æ¥å¯¹è±¡å’ŒçŠ¶æ€ï¼Œè¿›è¡Œè¯»å†™æˆ–çŠ¶æ€æœºå¤„ç†ã€‚

ä»¥å‰æˆ‘ä»¬å¿…é¡»æ£€æŸ¥æ¯ä¸€ä¸ªè¿æ¥ï¼Œçœ‹çœ‹æ˜¯å¦æœ‰ä»€ä¹ˆå˜å¾—å°±ç»ªï¼Œä½†ç°åœ¨ç”± epoll æ¥å¤„ç†ï¼Œé¿å…äº†ä»»ä½•æ— ç”¨çš„ç³»ç»Ÿè°ƒç”¨ã€‚
```rust
// ...

// epollå‘Šè¯‰æˆ‘ä»¬è¿æ¥æ˜¯å¦å°±ç»ª
let (connection, state) = connections.get_mut(&fd).unwrap();

if let ConnectionState::Read { request, read } = state {
    // connection.read...
    *state = ConnectionState::Write { response, written };
}

if let ConnectionState::Write { response, written } = state {
    // connection.write...
    *state = ConnectionState::Flush;
}

if let ConnectionState::Flush = state {
    // connection.flush...
}


```
æ‰€æœ‰æ“ä½œéƒ½å®Œæˆåï¼Œæˆ‘ä»¬ä» connections ä¸­ç§»é™¤å½“å‰è¿æ¥ï¼Œå®ƒä¼šè‡ªåŠ¨ä» epoll ä¸­æ³¨é”€ã€‚
```rust
for fd in completed {
    let (connection, _state) = connections.remove(&fd).unwrap();
    // ä¼šè‡ªåŠ¨ä»epollæ³¨é”€
    drop(connection);
}

```
- å‡å¦‚ä½ ç”¨ Rust çš„Â `TcpStream`Â ä½œä¸ºè¿æ¥å¯¹è±¡ï¼Œ`TcpStream`Â åœ¨ drop æ—¶ä¼šè‡ªåŠ¨ close fd