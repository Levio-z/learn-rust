### 概念

在分布式计算中， **远程过程调用** （**RPC**） 是指计算机程序导致过程（子例程）在不同的地址空间（通常在共享计算机网络上的另一台计算机上）执行，其编写方式就好像它是普通的（本地）过程调用一样，而程序员没有明确写入远程交互的详细信息。

>RPC ≈ 远程通信封装成“函数调用”的编程抽象。

分析：
- **“不同地址空间”**：本质上就是“不同机器、不同进程”，**不能直接共享内存**
- **“远程机器”**：远端服务通常位于网络中另一台主机上，通过 TCP/UDP/HTTP 等协议访问
- **“就像本地过程调用一样”**：RPC 的设计目标是：让你 _以调用本地函数的方式_ 去调用远程服务函数，**屏蔽底层网络通信细节**
	- 位置透明度：**位置透明度**，即调用过程是本地还是远程，它们在很大程度上是相同的
- **”过程“**：过程（Procedure）或子例程（Subroutine）是指：一段可以被其他代码重复调用的、具有独立功能的代码块。

>也就是说，程序员编写的代码基本上是相同的，无论子例程是执行程序的本地还是远程。这是一种服务器交互形式（调用者是客户端，执行者是服务器），通常通过**请求-响应消息传递系统**实现。在面向对象的编程范例中，RPC 由远程方法调用 （RMI） 表示。RPC 模型意味着一定程度的**位置透明度**，即调用过程是本地还是远程，它们在很大程度上是相同的，但通常它们并不相同，因此本地调用可以与远程调用区分开来。远**程调用通常比本地调用慢几个数量级，可靠性也更低**，因此区分它们很重要。RPC 是进程间通信 （IPC） 的一种形式，因为不同的进程具有不同的地址空间：如果在同一台主机上，它们具有不同的虚拟地址空间，即使物理地址空间相同;而如果它们位于不同的主机上，则物理地址空间也不同。已经使用了许多不同的 （通常是不兼容的） 技术来实现这个概念。

### 基本原理
RPC 通常包含以下几个核心步骤：
- **客户端调用 stub（代理）方法**，该调用是本地过程调用，其中参数以正常方式推送到堆栈上。
- stub 将方法参数 **序列化（编码）**，并进行系统调用以发送消息。打包参数称为封送处理。
- 客户端的本地作系统将消息从客户端计算机发送到服务器计算机。
- 服务器计算机上的本地作系统将传入的数据包传递到服务器stub。
- 服务端 stub **接收请求、反序列化**
- **调用目标方法**，获得返回值
- **序列化返回值**，通过网络返回客户端
- 客户端 stub **反序列化**，返回给调用者
```
Client                Network                Server
  |    stub.call()      --->              stub.invoke()
  |  =============>    encode + send   =============>
  | <=============    decode + return <=============

```
**RPC 的工作原理:**
1. **客户端**程序向 **服务器**程序发送一个请求消息，其中包含要调用的函数名、参数和其他信息。
2. 服务器程序收到请求消息后，执行指定的函数，并将结果封装在响应消息中发送回客户端程序。
3. 客户端程序收到响应消息后，继续执行。
**RPC 的优点:**
- **简化开发:** 隐藏了网络通信的细节，使得开发分布式应用程序更加容易。
- **透明性:** 使得远程函数调用看起来像本地函数调用一样，提高了代码的可读性和可维护性。
- **效率:** 对于简单的数据结构和函数调用，RPC 可以提供较高的效率。
**RPC 的缺点:**
- **安全性:** 需要考虑网络通信的安全问题，例如身份验证、授权和数据加密。
- **复杂性:** 对于复杂的数据结构或异步调用，RPC 的实现和调试可能比较复杂。
- **性能:** 对于大数据传输或复杂交互，RPC 的性能可能不如其他分布式通信方式。
**RPC 的应用场景:**
- 分布式系统：用于在不同计算机上调用的函数调用。
- 微服务架构：用于在不同的微服务之间进行通信。
- 云计算：用于在云端服务器上调用函数。
**常见的 RPC 协议:**
- **gRPC:** 由 Google 开发的高性能、协议无关的 RPC 框架。
- **REST:** 不是真正的 RPC 协议，但由于其简单性和流行性，经常用于 API 设计。
- **XML-RPC:** 使用 XML 作为消息格式，使用 HTTP 作为传输协议。
- **JSON-RPC:** 使用 JSON 作为消息格式，使用 HTTP 作为传输协议。
- **Thrift:** 支持多种语言和平台的 RPC 框架，具有丰富的功能和良好的性能。

**总结:**

RPC 是一种重要的分布式计算技术，可以简化分布式应用程序的开发和部署。选择合适的 RPC 协议可以提高应用程序的性能、安全性和其他特性。
### 常见组件

| 组件       | 说明                             |
| -------- | ------------------------------ |
| 客户端 stub | 本地调用的代理函数                      |
| 服务端 stub | 接收请求并调用目标服务逻辑                  |
| 序列化/反序列化 | 将结构体转为二进制（如 JSON、Protobuf）     |
| 网络传输层    | 支持传输 RPC 消息的通道，如 TCP、HTTP、QUIC |
| 注册中心（可选） | 用于服务发现，如 etcd、Consul、Zookeeper |
### 架构图
        +-----------+               +-------------+
        |  Client   |               |   Server    |
        |-----------|               |-------------|
        | call()    |               | foo(x)      |
        |  ↓        |               |     ↑       |
        | stub      | --TCP/HTTP--> | stub        |
        | encoder   |               | decoder     |
        +-----------+               +-------------+
### RPC vs RESTful API
|维度|RPC|RESTful HTTP API|
|---|---|---|
|调用风格|类似本地函数调用|URL + HTTP 动词|
|性能|高效（如 gRPC）|相对低，基于 HTTP/1.x、文本|
|序列化格式|通常使用 Protobuf、MsgPack 等|通常为 JSON|
|接口语义|基于方法名（强类型）|基于资源路径（松散类型）|
|易用性|自动生成客户端代码、调用简洁|调用语义清晰，语言无关|
### 常见序列化协议对比

|协议|特点|
|---|---|
|JSON|可读性强，广泛使用，性能一般|
|Protobuf|二进制格式，紧凑高效，跨语言支持强|
|MsgPack|类似 JSON，性能优于 JSON|
|Avro|Apache 大数据生态常用|
### 可靠性设计要点
- 超时控制（context、deadline）
- 重试机制（幂等性）
-  服务注册与发现
- 心跳与健康检查
- 负载均衡与熔断
- 链路追踪（如 Zipkin、OpenTelemetry）
### 进阶专题
|主题|内容|
|---|---|
|分布式事务|如何跨多个 RPC 保证一致性（如 Saga、2PC）|
|服务治理|服务发现、限流、熔断、降级|
|RPC 调用链追踪|tracing context、traceID、OpenTelemetry|
|性能优化|连接池、批量请求、压缩、零拷贝等|
|安全|TLS 加密、token、mTLS、认证授权|