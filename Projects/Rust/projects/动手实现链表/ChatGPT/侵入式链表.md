æˆ‘ä»¬æ¥ä¸€åœºæ·±å…¥å‰–æï¼šä»€ä¹ˆæ˜¯ä¾µå…¥å¼é“¾è¡¨ã€ä¸ºä»€ä¹ˆå†…æ ¸å–œæ¬¢å®ƒã€åœ¨ Rust ä¸­å¦‚ä½•å®‰å…¨ï¼ˆæˆ–ä¸å®‰å…¨ï¼‰å®ç°å®ƒã€‚

* * *

## ğŸ”§ ä¸€ã€ä»€ä¹ˆæ˜¯**ä¾µå…¥å¼é“¾è¡¨ï¼ˆIntrusive Listï¼‰**ï¼Ÿ

### ğŸ“Œ å®šä¹‰ï¼š

**ä¾µå…¥å¼é“¾è¡¨**æŒ‡çš„æ˜¯ï¼š**é“¾è¡¨çš„èŠ‚ç‚¹ç»“æ„åµŒå…¥åœ¨å…ƒç´ æœ¬ä½“å†…éƒ¨**ï¼Œè€Œä¸æ˜¯å…ƒç´ ç”±é“¾è¡¨ç»“æ„åŒ…è£¹ã€‚

å¯¹æ¯”å›¾ç¤ºï¼š

| ç±»å‹ | ç»“æ„ | ç‰¹ç‚¹ |
| --- | --- | --- |
| éä¾µå…¥å¼ | `LinkedList<T>` åŒ…è£¹ `T` | é€šç”¨ã€å®‰å…¨ï¼Œä½†éœ€é¢å¤–åˆ†é…æ¯ä¸ªèŠ‚ç‚¹ |
| ä¾µå…¥å¼ | `T` è‡ªèº«åŒ…å«æŒ‡é’ˆå­—æ®µ | æ›´é«˜æ•ˆï¼Œä½†å…ƒç´ å¿…é¡»å®ç°ç‰¹å®šæ¥å£ |

### âœ… ä¼˜ç‚¹ï¼š

* **æ²¡æœ‰é¢å¤–çš„å †åˆ†é…**ï¼Œç»“æ„å…¨åœ¨æ ˆæˆ–é™æ€åˆ†é…åŒºä¸­
* **æ›´ä½å†…å­˜å ç”¨**ï¼Œæ— è£…ç®±ï¼ˆBoxï¼‰å¼€é”€
* **ç”Ÿå‘½å‘¨æœŸä¸ä¸šåŠ¡å¯¹è±¡åŒæ­¥**ï¼Œæ›´å®¹æ˜“â€œå°±åœ°ä¿®æ”¹â€
* **å¯ä»¥å¤ç”¨èŠ‚ç‚¹ç»“æ„ç”¨äºå¤šä¸ªé“¾è¡¨**ï¼ˆè¿™ç‚¹å°¤å…¶å¼ºå¤§ï¼‰

* * *

## ğŸ§  äºŒã€ä¸ºä»€ä¹ˆå†…æ ¸ä»£ç å–œæ¬¢ç”¨ä¾µå…¥å¼é“¾è¡¨ï¼Ÿ

### ä»¥ Linux å†…æ ¸ä¸ºä¾‹ï¼š

Linux å†…æ ¸å¹¿æ³›ä½¿ç”¨ `list_head` å®ç°ä¾µå…¥å¼åŒå‘é“¾è¡¨ï¼š

```c
struct task_struct {
    ...
    struct list_head run_list;
    ...
};
```

ä½¿ç”¨å®æ¥æ’å…¥/åˆ é™¤èŠ‚ç‚¹ï¼š

```c
list_add(&task->run_list, &some_queue);
```

### ç†ç”±ï¼š

| éœ€æ±‚                | é“¾è¡¨ä¼˜åŠ¿                 |
| ----------------- | -------------------- |
| å†…æ ¸ç»“æ„ä½“å¸¸å¸¸è¦è¢«è°ƒåº¦/å›æ”¶/åˆ†ç»„ | åµŒå…¥æŒ‡é’ˆæœ€çœäº‹              |
| ä¸èƒ½é¢‘ç¹å †åˆ†é…           | é™æ€/æ ˆä¸Šç»“æ„å¿…é¡»å°±åœ°ä¿®æ”¹        |
| æ—  GCï¼Œæ—  Boxï¼Œæ— æ™ºèƒ½æŒ‡é’ˆ  | ä¾µå…¥å¼è®¾è®¡æ˜¯æœ€åˆé€‚çš„           |
| ç»“æ„é—´å…±äº«å¤šä¸ªé“¾è¡¨         | æ¯ä¸ªç»“æ„ä½“å¯ä»¥æŒ‚å¤šä¸ª list_head |

* * *

## ğŸ¦€ ä¸‰ã€Rust ä¸­å®ç°ä¾µå…¥å¼é“¾è¡¨çš„æ–¹æ³•

### æ–¹å¼ä¸€ï¼š`unsafe` + `NonNull<T>` æ‰‹å†™å®ç°

ç»å…¸å®šä¹‰ï¼š

```rust
use std::ptr::NonNull;

pub struct ListNode<T> {
    pub prev: Option<NonNull<ListNode<T>>>,
    pub next: Option<NonNull<ListNode<T>>>,
    pub value: T,
}
```

æ³¨æ„ç‚¹ï¼š

* ä½¿ç”¨ `NonNull<T>` é¿å…ç©ºæŒ‡é’ˆ + æ€§èƒ½æŸè€—
    
* å¿…é¡»æ‰‹åŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸï¼ˆ`unsafe`ï¼‰
    
* æ’å…¥/ç§»é™¤éƒ½è¦æ±‚æé«˜çš„æ­£ç¡®æ€§å’Œç»†èŠ‚å¤„ç†
    

### æ–¹å¼äºŒï¼šä½¿ç”¨ `intrusive-collections` crateï¼ˆæ¨èï¼‰

```toml
# Cargo.toml
intrusive-collections = "0.9"
```

```rust
use intrusive_collections::{intrusive_adapter, LinkedList, LinkedListLink};

struct MyNode {
    link: LinkedListLink,
    data: usize,
}

intrusive_adapter!(MyAdapter = Box<MyNode>: MyNode { link: LinkedListLink });

let mut list = LinkedList::new(MyAdapter::new());
list.push_back(Box::new(MyNode { link: LinkedListLink::new(), data: 42 }));
```

ä¼˜åŠ¿ï¼š

* å®Œå…¨ zero-cost abstraction
    
* æ˜ç¡®åˆ†ç¦» link ä¸ value
    
* å®‰å…¨å°è£…äº† pointer æ“ä½œ
    

### æ–¹å¼ä¸‰ï¼š`kernel` crate ä¸­çš„ `list::ListHead<T>`

å¦‚æœä½ åœ¨å†™ **Rust å†…æ ¸æ¨¡å—ï¼ˆRust-for-Linuxï¼‰**ï¼Œå®ƒæœ¬èº«å·²ç»æä¾›å°è£…ï¼š

```rust
use kernel::list::ListHead;

struct MyTask {
    links: ListHead<MyTask>,
}
```

å®Œå…¨æ¨¡æ‹Ÿ C å†…æ ¸ä¸­çš„ `list_head` è¯­ä¹‰ï¼Œä½†æ˜¯å®‰å…¨å°è£…ã€‚

* * *

## ğŸ“˜ å››ã€è®¾è®¡ä¸Šçš„è¦ç‚¹ä¸æ³¨æ„äº‹é¡¹

### âœ… å¦‚æœä½ è¦æ„å»ºçš„æ˜¯ä¸€ä¸ª**é€šç”¨è°ƒåº¦å™¨ã€å†…å­˜åˆ†é…å™¨æˆ–ä»»åŠ¡è¡¨**ï¼Œæ¨èï¼š

| ç»“æ„ä½“ | ç‰¹å¾ |
| --- | --- |
| `T` æœ¬èº«åµŒå…¥ä¸€ä¸ª `ListLink` | å®ç°ç»“æ„ä¸è°ƒåº¦è§£è€¦ |
| è‡ªå®šä¹‰ `adapter` | å¤šç§é“¾è¡¨æŒ‚æ¥åŒä¸€æ•°æ®ç»“æ„ |
| ä½¿ç”¨ `arena` åˆ†é… T | é¿å…é¢‘ç¹å †åˆ†é…/é‡Šæ”¾ |

### âš ï¸ æ³¨æ„ï¼š

* ä¾µå…¥å¼é“¾è¡¨é€šå¸¸ä¼šè¿èƒŒ Rust çš„å€Ÿç”¨è§„åˆ™ï¼ˆæ¯”å¦‚åŒæ—¶æŒæœ‰å¤šä¸ªæŒ‡é’ˆï¼‰
* è¦ä¹ˆä½¿ç”¨ `unsafe` + ç”Ÿå­˜æœŸä¸¥æ ¼æ§åˆ¶ï¼Œè¦ä¹ˆä½¿ç”¨å°è£…è‰¯å¥½çš„åº“
* ä¸è¦æ··ç”¨ Rust å®‰å…¨å®¹å™¨ä¸è£¸æŒ‡é’ˆé“¾è¡¨ï¼Œå®¹æ˜“ç‚¸é”…
    

* * *

## ğŸ¯ æ€»ç»“

| ç‰¹æ€§          | ä¾µå…¥å¼é“¾è¡¨ä¼˜åŠ¿                                      |
| ----------- | -------------------------------------------- |
| å†…å­˜æ•ˆç‡        | æ—  Box / Rc / Vecï¼Œç»“æ„ä½“å†…åµŒå­—æ®µ                     |
| æ€§èƒ½          | æ’å…¥åˆ é™¤åªåŠ¨æŒ‡é’ˆï¼Œå®Œå…¨ O(1)                             |
| å¤šé“¾è¡¨æ”¯æŒï¼ˆå…±äº«èŠ‚ç‚¹ï¼‰ | ä¸€ä¸ªç»“æ„ä½“å¯æŒ‚å¤šé“¾è¡¨ï¼Œè°ƒåº¦å™¨/åˆ†åŒºè¡¨æœ€çˆ±                         |
| Rustç”Ÿæ€æ”¯æŒ    | æœ‰åº“ï¼ˆ`intrusive-collections`ã€`kernel::list`ï¼‰èƒ½ç”¨ |

* * *

## ğŸ“¦ Bonusï¼šä½ æƒ³å®ç°å“ªä¸ªï¼Ÿ

* Rust å®ç° `task_struct` + `ListHead` çš„å®Œæ•´ç¤ºä¾‹ï¼ˆå¯¹æ ‡ Linuxï¼‰
    
* intrusive åŒå‘é“¾è¡¨å®‰å…¨å°è£…çš„ç®€æ´åº“ï¼ˆéä¾µå…¥å¼ä¹Ÿå¯å¯¹æ¯”ï¼‰
    
* è‡ªå®šä¹‰ arena + intrusive list çš„ä»»åŠ¡è°ƒåº¦é˜Ÿåˆ—
    

å¯ç»“åˆä½ çš„è°ƒåº¦å™¨/å†…æ ¸å®éªŒ/ä»»åŠ¡ç®¡ç†å™¨ç­‰ç›®æ ‡åšå®šåˆ¶å®ç°ã€‚æ˜¯å¦éœ€è¦æˆ‘ç°åœ¨ç›´æ¥èµ·è‰ä»£ç ç»“æ„ï¼Ÿ

* * *

**You:**

å†…æ ¸ç»“æ„ä½“å¸¸å¸¸è¦è¢«è°ƒåº¦/å›æ”¶/åˆ†ç»„	åµŒå…¥æŒ‡é’ˆæœ€çœäº‹
ä¸èƒ½é¢‘ç¹å †åˆ†é…	é™æ€/æ ˆä¸Šç»“æ„å¿…é¡»å°±åœ°ä¿®æ”¹

* * *

**ChatGPT:**

ä½ è¿™ä¸¤ç‚¹æ˜¯å†…æ ¸è®¾è®¡ä½¿ç”¨ä¾µå…¥å¼é“¾è¡¨çš„æ ¸å¿ƒåŠ¨å› ï¼ŒæŠ“ä½äº†å…³é”®æ‰€åœ¨ã€‚æˆ‘æ¥å¸®ä½ åšä¸ªä¸“ä¸šä¸”æ·±å…¥çš„åˆ†æï¼Œå¸®ä½ ç†è§£ä¸ºä»€ä¹ˆå†…æ ¸å¿…é¡»è¿™æ ·åšï¼Œä»¥åŠ Rust ç”Ÿæ€ä¸‹çš„å¯¹åº”å®è·µã€‚

* * *

## 1. å†…æ ¸ç»“æ„ä½“å¸¸å¸¸è¦è¢«è°ƒåº¦ / å›æ”¶ / åˆ†ç»„ï¼ŒåµŒå…¥æŒ‡é’ˆæœ€çœäº‹

### èƒŒæ™¯

* å†…æ ¸ä¸­æ¯ä¸ªâ€œä»»åŠ¡â€æˆ–è€…â€œèµ„æºâ€æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼ˆå¦‚ Linux çš„ `task_struct`ï¼‰
* è¿™äº›ç»“æ„ä½“å¾€å¾€**éœ€è¦åŒæ—¶æŒ‚è½½åˆ°å¤šä¸ªé“¾è¡¨**ä¸Šï¼Œæ¯”å¦‚ï¼š
    * å°±ç»ªé˜Ÿåˆ—é“¾è¡¨ï¼ˆè°ƒåº¦
    * ç­‰å¾…é˜Ÿåˆ—é“¾è¡¨ï¼ˆåŒæ­¥ï¼‰    
    * å†…å­˜å›æ”¶é“¾è¡¨ï¼ˆåƒåœ¾å›æ”¶ï¼‰ 
* è¿™äº›é“¾è¡¨ä¸æ˜¯â€œåŒ…è£¹â€ç»“æ„ä½“ï¼Œè€Œæ˜¯ç›´æ¥å°†é“¾è¡¨æŒ‡é’ˆåµŒå…¥ç»“æ„ä½“å†…éƒ¨

### ä¼˜åŠ¿

* **æ— é¢å¤–å†…å­˜åˆ†é…**ï¼Œå‡å°‘åˆ†é…å¤æ‚åº¦å’Œç¢ç‰‡
* æ•ˆç‡ï¼šä¸ç”¨æŒ‡é’ˆæŒ‡å‘å¤–éƒ¨èŠ‚ç‚¹ï¼Œ**é¿å…äºŒæ¬¡è·³è½¬ï¼Œè®¿é—®æ›´å¿«**
	* ç»“æ„ä½“æœ¬èº«å°±æ˜¯é“¾è¡¨èŠ‚ç‚¹ï¼Œ**ä»£ç æ“ä½œç›´è§‚ä¸”æ•ˆç‡æé«˜**
* å…±äº«ï¼šå¯ä»¥æ–¹ä¾¿åœ°å®ç°â€œä¸€ä¸ªç»“æ„ä½“æŒ‚å¤šä¸ªé“¾è¡¨â€ï¼Œæ»¡è¶³å¤æ‚è°ƒåº¦å’Œèµ„æºç®¡ç†éœ€æ±‚
    

* * *

## 2. ä¸èƒ½é¢‘ç¹å †åˆ†é…ï¼Œé™æ€/æ ˆä¸Šç»“æ„å¿…é¡»å°±åœ°ä¿®æ”¹

### åŸå› 

* **å†…æ ¸è¿è¡Œç¯å¢ƒæç«¯çº¦æŸ**
    * ä¸å…è®¸é˜»å¡çš„å†…å­˜åˆ†é…ï¼ˆæœ‰äº›åˆ†é…å™¨åœ¨å†…æ ¸æ€å¯èƒ½é˜»å¡ï¼‰
    * å†…å­˜ç¢ç‰‡å¯¹æ€§èƒ½å’Œç¨³å®šæ€§å±å®³å¤§
* **å®æ—¶æ€§è¦æ±‚é«˜**
    * å†…æ ¸è°ƒåº¦å™¨ã€é©±åŠ¨ç­‰æ¨¡å—å¿…é¡»é«˜æ•ˆã€ç¡®å®šæ€§
    * å †åˆ†é…å¯èƒ½å¯¼è‡´ä¸å¯é¢„æµ‹çš„å»¶è¿Ÿ
* **å†…æ ¸æ•°æ®ç»“æ„å¤§å¤šæ˜¯å…¨å±€æˆ–é™æ€ç”Ÿå‘½å‘¨æœŸ**
    * å¾ˆå¤šå†…æ ¸å¯¹è±¡æ˜¯é™æ€åˆ†é…æˆ–é¢„åˆ†é…å†…å­˜æ± ä¸­çš„ä¸€éƒ¨åˆ†
    * ä¸å¯ä¾èµ– GC æˆ–è¿è¡Œæ—¶ç³»ç»Ÿå›æ”¶

### ä¾µå…¥å¼é“¾è¡¨ä¼˜åŠ¿

* å†…æ ¸ç»“æ„ä½“ä¸­çš„é“¾è¡¨æŒ‡é’ˆå°±æ˜¯ç»“æ„ä½“çš„ä¸€éƒ¨åˆ†ï¼Œ**æ“ä½œé“¾è¡¨ä¸æ”¹å˜å†…å­˜å¸ƒå±€**
* åªä¿®æ”¹æŒ‡é’ˆï¼Œé¿å…åˆ†é…å’Œé‡Šæ”¾æ“ä½œå¸¦æ¥çš„ç³»ç»Ÿè°ƒç”¨æˆ–é”ç«äº‰
* æ”¯æŒå¯¹æ ˆä¸Šã€é™æ€æ•°æ®ç»“æ„â€œå°±åœ°â€ä¿®æ”¹ï¼Œæ— éœ€æ‹·è´æˆ–é‡æ–°åˆ†é…
    

* * *

## 3. Rust ç”Ÿæ€ä¸­çš„å¯¹åº”å®è·µ

* **Rust å†…æ ¸æ¨¡å—ï¼ˆRust-for-Linuxï¼‰**
    
    * æä¾›ç±»ä¼¼ Linux å†…æ ¸çš„ `list_head` å°è£…
        
    * é€šè¿‡ unsafe + trait è¾…åŠ©å®ç°ä¾µå…¥å¼é“¾è¡¨
        
* **`intrusive-collections` crate**
    
    * å®Œå–„çš„ä¾µå…¥å¼é“¾è¡¨å®ç°ï¼Œé€‚åˆç”¨æˆ·æ€å¤æ‚åœºæ™¯
        
* **è‡ªå®šä¹‰ arena + ä¾µå…¥å¼é“¾è¡¨**
    
    * åœ¨è°ƒåº¦å™¨ã€ä»»åŠ¡ç®¡ç†ä¸­å¤ç”¨å†…å­˜ï¼Œå‡å°‘åˆ†é…å¼€é”€
        

* * *

## 4. ç»“è¯­

> å†…æ ¸æ•°æ®ç»“æ„å¿…é¡»é«˜æ•ˆã€ç¡®å®šä¸”å¯æ§ï¼Œä¾µå…¥å¼é“¾è¡¨å°†â€œèŠ‚ç‚¹åµŒå…¥å…ƒç´ â€çš„è®¾è®¡å“²å­¦å®Œç¾å¥‘åˆäº†è¿™ä¸€éœ€æ±‚ï¼ŒåŒæ—¶è§„é¿äº†å †åˆ†é…å¸¦æ¥çš„æ€§èƒ½å’Œå¤æ‚æ€§é—®é¢˜ã€‚

è¿™ä¹Ÿæ˜¯å†…æ ¸ä»£ç å‡ ä¹ä¸ä½¿ç”¨éä¾µå…¥å¼é“¾è¡¨çš„æ ¹æœ¬åŸå› ã€‚

* * *

å¦‚æœä½ éœ€è¦ï¼Œæˆ‘å¯ä»¥å¸®ä½ ï¼š

* ç»“åˆ Rust å±•ç¤ºä¾µå…¥å¼é“¾è¡¨åœ¨å†…æ ¸è°ƒåº¦ä¸­çš„ç¤ºä¾‹ä»£ç 
    
* è®²è§£å†…æ ¸å†…å­˜åˆ†é…çº¦æŸå¯¹é“¾è¡¨è®¾è®¡çš„å½±å“ç»†èŠ‚
    
* æ¼”ç¤ºå¦‚ä½•å®‰å…¨ç®¡ç†é“¾è¡¨èŠ‚ç‚¹ç”Ÿå‘½å‘¨æœŸå’ŒæŒ‡é’ˆæ“ä½œ
    