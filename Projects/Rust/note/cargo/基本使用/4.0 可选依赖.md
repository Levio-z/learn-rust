## 🧩 示例：添加可选依赖

### 步骤 1：添加 `foo` 为可选依赖

```bash
cargo add foo --optional
```

在 `Cargo.toml` 中会生成：

```toml
[dependencies]
foo = { version = "x.y.z", optional = true }
```

此时，即使你运行 `cargo build`，**也不会编译 `foo`**，因为它没有被启用。

---

### 步骤 2：通过 features 显式启用

```toml
[features]
default = []         # 默认不启用任何可选功能
use_foo = ["foo"]    # 新增一个 feature，启用 foo
```

你可以这样构建项目并启用 `foo`：

```bash
cargo build --features use_foo
```

这时候 `foo` 才会被真正加入编译依赖图中。

---

## 🔍 使用场景示意

例如你有一个库 `my-lib`，默认提供核心功能，但如果用户启用了 `serde`，就可以让结构体支持序列化：

```toml
[dependencies]
serde = { version = "1.0", optional = true, features = ["derive"] }

[features]
default = []
with-serde = ["serde"]
```

```rust
#[cfg(feature = "with-serde")]
use serde::{Serialize, Deserialize};

#[cfg_attr(feature = "with-serde", derive(Serialize, Deserialize))]
pub struct Config {
    pub id: u32,
}
```

---

## 🎯 总结

| 可选依赖 | 说明 |
| --- | --- |
| `optional = true` | 表示不会自动启用，必须通过 `features` 显式开启 |
| 作用 | 降低默认编译成本，提升灵活性；适合用于插件化、平台差异支持等 |
| 配套机制 | `features` 机制一起使用 |

---