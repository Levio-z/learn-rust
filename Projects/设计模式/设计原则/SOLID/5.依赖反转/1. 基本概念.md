### 基本定义
依赖反转，Dependency Inversion Principle，缩写为 DIP
>High-level modules shouldn’t depend on low-level modules. Both modules
should depend on abstractions. In addition, abstractions shouldn’t depend on
details. Details depend on abstractions

高层模块（high-level modules）不要依赖低层模块（low-level）。高层模块和低层模块应该通过抽象（abstractions）来互相依赖。除此之外，抽象（abstractions）不要依赖具体实现细节（details），具体实现细节（details）依赖抽象（abstractions）。

所谓高层模块和低层模块的划分，简单来说就是，在调用链上，调用者属于高层，被调用者属于低层。在平时的业务代码开发中，高层模块依赖底层模块是没有任何问题的。实际上，这条原则主要还是用来指导框架层面的设计，跟前面讲到的控制反转类似。我们拿 Tomcat这个 Servlet 容器作为例子来解释一下。

Tomcat 是运行 Java Web 应用程序的容器。我们编写的 Web 应用程序代码只需要部署在
Tomcat 容器下，便可以被 Tomcat 容器调用执行。按照之前的划分原则，Tomcat 就是高
层模块，我们编写的 Web 应用程序代码就是低层模块。Tomcat 和应用程序代码之间并没
有直接的依赖关系，两者都依赖同一个“抽象”，也就是 Sevlet 规范。Servlet 规范不依
赖具体的 Tomcat 容器和应用程序的实现细节，而 Tomcat 容器和应用程序依赖 Servlet
规范。

#### 概念混淆
控制反转：
- 框架提供了一个可扩展的代码骨架，用来组装对象、管理整个执行流程。程序员利用框架进行开发的时候，只需要往预留的扩展点上，添加跟自己业务相关的代码，就可以利用框架来驱动整个程序流程的。
- 控制反转一个比较笼统的设计思想，一般用来指导框架层面的设计。
- 实现
	- 依赖注入
	- 模板实现
依赖注入
- 不通过 new() 的方式在类内部创建依赖类对象，而**是将依赖的类对象在外部创建好之后，通过构造函数、函数参数等方式传递（或注入）给类使用。**
	- 通过依赖注入的方式来将依赖的类对象传递进来，这样就提高了代码的扩展性，我们可以灵活地替换依赖的类。
	- 依赖注入+基于接口和实现编程 提高扩展性实现开闭原则
依赖注入框架
- 扩展时，创建对象、组装（或注入）对象的工作仅仅是被移动到了更上层代码而已，还是需要我们程序员自己来实现。
- 在实际的软件开发中，一些项目可能会涉及几十、上百、甚至几百个类，类对象的创建和依赖注入会变得非常复杂。如果这部分工作都是靠程序员自己写代码来完成，容易出错且开发成本也比较高。而对象创建和依赖注入的工作，本身跟具体的业务无关，我们完全可以抽象成框架来自动完成。
- 我们只需要**通过依赖注入框架提供的扩展点，简单配置一下所有需要创建的类对象、类与类之间的依赖关系，就可以实现由框架来自动创建对象、管理对象的生命周期、依赖注入等原本需要程序员来做的事情。**
#### 为什么需要
- **降低耦合**：高层模块可独立于具体实现更换底层模块。
- **提升可扩展性**：可以灵活替换、扩展细节实现，而不修改高层逻辑。
- **增强可测试性**：通过依赖注入或接口替换，可以轻松进行 mock、stub 测试。
- **支持开闭原则（OCP）**：系统对扩展开放、对修改关闭。
### 依赖反转的反转在哪里
#### 依赖
一个模块（A）使用了另一个模块（B）的接口、类型、方法、数据，A 就依赖 B。
高层模块（业务逻辑）依赖低层模块（工具、驱动、库、数据库实现）。
这里 `高层 = 应用逻辑`，直接用 `SqlDatabase`，导致高层依赖低层的具体实现。
#### 传统设计（依赖方向）
高层模块（业务、控制） ---> 低层模块（具体实现、工具、库）
这种设计有问题：

- 如果低层换了（例如要换成内存数据库、Mock），高层模块得全改。
    
- 如果低层升级或重构，高层受牵连。
    
- 测试困难，因为高层紧耦合特定实现。
- **换句话说：高层被迫跟着细节走，完全绑死。**
#### 依赖反转的“反转”点
```lua
高层模块（业务、控制） <--- 抽象（接口、trait）
                               ^
                               |
                     低层模块（具体实现、工具、库）

```
- **高层**不再直接依赖低层，而是依赖**抽象接口**（比如 trait）。
- **低层**也依赖抽象（因为它要去实现这个 trait）。
- 低层实现通过注入或绑定提供给高层。
→ 这就是所谓的“反转”。