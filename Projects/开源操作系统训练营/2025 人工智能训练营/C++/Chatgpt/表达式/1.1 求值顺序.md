## 1\. 定义

**求值顺序（Evaluation order）** 指的是：在表达式求值过程中，编译器对各个子表达式或参数进行计算的先后顺序。

C++ 中对 **参数传递给函数** 和 **表达式内部子表达式** 的求值顺序规则非常重要，决定了中间结果的生成和副作用的执行顺序。

---

## 2\. 作用

-   **保证程序的语义一致性和副作用的正确执行顺序**
    
-   **避免因顺序未定义导致的未定义行为或不确定结果**
    
-   **提高编译器优化自由度，同时允许程序员明确顺序需求**
    

---

## 3\. 标准中对参数和子表达式的求值顺序

### 参数的求值顺序

根据 C++17 标准，**函数参数的求值顺序未定义**，即：

```cpp
foo(f1(), f2());
```

-   `f1()` 和 `f2()` 哪个先执行，标准不规定，编译器可以自由选择。
    
-   两个函数调用之间的顺序不确定，且可能交错。
    

这点是 C++ 长期以来最难以理解的部分，直到 C++17 之前，参数的求值顺序都是未定义的。C++17 及以后引入了更严格的序列点和顺序规则，但参数列表的求值顺序依然是未指定（unspecified），**不是未定义（undefined）**。

### 子表达式的求值顺序

-   **对于大部分二元运算符（如 `+`, `*`, `&&`, `||`）的左右操作数，求值顺序未定义。**
    
-   **对于逗号运算符（`,`），左操作数先求值，且副作用完成后再求右操作数。**
    
-   **对于逻辑与 `&&`、逻辑或 `||`，是短路求值，先求左操作数，满足条件后才可能求右操作数。**
    

---

## 4\. 详细源码解析和示例

```cpp
int a() { std::cout << "a\n"; return 1; }
int b() { std::cout << "b\n"; return 2; }

int main() {
    int x = a() + b();         // a() 和 b() 先后顺序未定义
    int y = (a(), b());        // 逗号运算符保证 a() 先执行，b() 后执行
    int z = a() && b();        // 逻辑与，a() 先执行，若 a() 为 false，b() 不执行
    return 0;
}
```

输出结果中 `a` 和 `b` 的顺序在第一行可能是 `a b` 或 `b a`，但逗号运算符和逻辑运算符保证了顺序。

---

## 5\. 原理

-   **历史原因**：C++ 继承自 C 语言，设计时给编译器最大优化自由度，未明确规定求值顺序。
    
-   **编译器自由度**：未指定顺序允许编译器更灵活地重排指令，提高性能。
    
-   **副作用控制**：若程序依赖参数的求值顺序，会造成未定义或不确定行为。
    

---

## 6\. 使用场景与风险

-   **避免在函数参数中依赖求值顺序写代码。**
    
-   **避免参数或表达式中同时存在多个对同一变量的修改和访问（如 `f(i++, i++)`）。**
    
-   **如果需要顺序保证，使用序列点或显式表达式分开写。**
    

---

## 7\. 扩展知识点

-   **C++17 引入了“顺序点”的细化，改进了副作用的定义。**
    
-   **C++20 的 `consteval` 和 `constexpr` 函数对求值顺序提供更严格语义。**
    
-   **某些特定运算符如 `&&`, `||`, `?:`, 逗号运算符有明确的顺序规定。**
    
-   **表达式模板、编译器内联优化对求值顺序影响大。**
    

---

## 8\. 总结

| 内容 | 说明 |
| --- | --- |
| 函数参数求值顺序 | 未指定（unspecified），编译器自由选择 |
| 二元运算符左右操作数求值 | 未指定，除非特殊运算符 |
| 逗号运算符 | 左先执行，副作用完成后右执行 |
| 逻辑运算符 (`&&`, \` |  |
| C++17 以后的规则 | 副作用更明确，未定义行为减少 |

---

如果您需要，我还可以帮您总结典型陷阱案例，或者结合具体代码帮您分析求值顺序带来的影响。

---