

引用折叠（Reference collapsing）是 C++ 中处理复合引用类型时的一条规则，主要用于解决“引用的引用”这种类型组合的问题。它在模板编程、完美转发中尤其关键。

---

## 一、为什么会有引用折叠？

在 C++ 中，引用不能直接对引用再引用，比如你不能写 `int& &`，但模板和类型推导有时会生成这种“引用的引用”形式，比如：

-   `T& &`
    
-   `T& &&`
    
-   `T&& &`
    
-   `T&& &&`
    

为了避免这种二义性和非法类型，C++ 定义了**引用折叠规则**来自动简化这些组合。

---

## 二、引用折叠规则

| 组合类型 | 折叠结果 |
| --- | --- |
| `T& &` | `T&` |
| `T& &&` | `T&` |
| `T&& &` | `T&` |
| `T&& &&` | `T&&` |

简言之：

-   **只要有一个是左值引用 (`&`)，结果就是左值引用。**
    
-   **只有两个都是右值引用 (`&& &&`)，结果才是右值引用。**
    

---

## 三、举例说明

```cpp
template<typename T>
void func(T&& param) {
    using U = decltype(param);    // param 的类型
    using V = decltype((param));  // param 作为表达式的类型
}

int x = 0;
func(x);   // T推导为 int&，所以 param 类型是 int& &&，折叠成 int&
func(0);   // T推导为 int，param 类型是 int&&
```

详细分析：

-   传入 `x` 时：
    
    -   `T` 推导为 `int&`
        
    -   `T&&` 展开为 `int& &&`
        
    -   根据规则折叠为 `int&`
        
-   传入字面量 `0` 时：
    
    -   `T` 是 `int`
        
    -   `T&&` 是 `int&&`，不折叠
        

---

## 四、引用折叠的作用

-   **保证引用类型始终合法**，避免产生“引用的引用”这种非法组合。
    
-   **支持完美转发**，能够根据传入参数的实际引用类型推导，正确保持左值或右值引用属性。
    
-   **简化模板编写和类型推导**，让代码逻辑更统一。
    

---

## 五、总结

| 组合类型 | 结果类型 | 说明 |
| --- | --- | --- |
| `T& &` | `T&` | 多重左值引用简化为左值引用 |
| `T& &&` | `T&` | 左值引用 + 右值引用折叠为左值引用 |
| `T&& &` | `T&` | 右值引用 + 左值引用折叠为左值引用 |
| `T&& &&` | `T&&` | 双右值引用保持右值引用 |

---