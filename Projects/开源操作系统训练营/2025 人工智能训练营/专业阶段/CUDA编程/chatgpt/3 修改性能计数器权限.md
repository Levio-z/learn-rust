## 解决方法（Linux，单机开发场景）

### **1\. 给当前用户开权限**

```bash
# 把当前用户加入 video 组（驱动通常要求这个权限）
sudo usermod -aG video $USER
# 重新登录才能生效（或执行 newgrp video）
```

---

### **2\. 修改性能计数器权限（持久化）**

驱动模块参数改为允许所有用户访问：

```bash
echo "options nvidia NVreg_RestrictProfilingToAdminUsers=0" | sudo tee /etc/modprobe.d/nvidia.conf
sudo update-initramfs -u
sudo reboot
```

重启后，再运行：

```bash
ncu --print-details all --nvtx --call-stack --set full ./target/add_gpu02
```

---

### **3\. 临时修改设备权限（重启后会恢复）**

找到性能计数器设备节点：

```bash
ls -l /dev/nvidia-caps/
```

一般会有两个文件，比如：

```lua
crw------- 1 root root  506, 0 Aug 12 15:00 nvidia-cap1
crw------- 1 root root  506, 1 Aug 12 15:00 nvidia-cap2
```

临时放开权限：

```bash
sudo chmod 666 /dev/nvidia-caps/*
```

之后就能运行 Nsight Compute 采集数据。

---

💡 我的建议：

-   如果你是**个人笔记本/工作站** → 方法 2 最好（持久化，不用每次改权限）
    
-   如果你是**共享服务器** → 方法 3 临时放开，不会影响别人
    

---

## 解决思路

核心就是 **允许当前用户访问 `/dev/nvidia-caps/` 设备节点**。

---

### **方案 1：永久开启所有用户访问性能计数器（单机推荐）**

1.  新增驱动模块配置：
    
    ```bash
    echo "options nvidia NVreg_RestrictProfilingToAdminUsers=0" | sudo tee /etc/modprobe.d/nvidia.conf
    ```
    
2.  更新内核模块缓存：
    
    ```bash
    sudo update-initramfs -u
    ```
    
3.  重启：
    
    ```bash
    sudo reboot
    ```
    

重启后就能直接运行：

```bash
ncu --print-details all --nvtx --call-stack --set full ./target/add_gpu02
```

---

### **方案 2：临时放开权限（重启会失效）**

1.  查看设备节点：
    
    ```bash
    ls -l /dev/nvidia-caps/
    ```
    
    可能会看到：
    
    ```lua
    crw------- 1 root root 506,   0 Aug 12 15:00 nvidia-cap1
    crw------- 1 root root 506,   1 Aug 12 15:00 nvidia-cap2
    ```
    
2.  临时改权限：
    
    ```bash
    sudo chmod 666 /dev/nvidia-caps/*
    ```
    

改完后再次运行 `ncu` 就可以采集数据了。

---

### **方案 3：给当前用户单独加访问权限**

1.  确保用户在 video 组：
    
    ```bash
    sudo usermod -aG video $USER
    ```
    
2.  用 `setfacl` 给当前用户访问权限：
    
    ```bash
    sudo setfacl -m u:$USER:rw /dev/nvidia-caps/*
    ```
    

---

📌 我的建议：

-   **你是自己笔记本/PC** → 用 **方案 1** 一劳永逸
    
-   **你在共享服务器** → 用 **方案 3**，避免影响其他用户
    

---

我可以帮你写一个 **一键检测 & 修复 Nsight Compute 权限** 的 Bash 脚本，  
这样你运行 `ncu` 之前自动搞定权限，不用每次手动敲命令。  
你要我帮你写吗？这样下次直接跑就能采集数据了。


### WSL GPU 分析限制

- WSL2 支持 GPU 加速（NVIDIA CUDA），但很多硬件层面的调试和性能分析功能受限。
- Nsight Compute 在 WSL 里只能做最基本的分析，不能访问底层硬件计数器。
- 这就是你看到 `ERR_NVGPUCTRPERM` 的根本原因，无法解决。
