### **1. 从最小化基础镜像开始**

- 使用官方轻量级镜像（如 `alpine`、`slim` 版本）
- 避免不必要的依赖和工具
```dockerfile
# 推荐：使用 Python 官方 slim 镜像（约 125MB）
FROM python:3.11-slim

# 不推荐：使用完整 Ubuntu 镜像（约 200MB+）
# FROM ubuntu:22.04
# RUN apt-get install python3
```
####  ARG（构建参数）的放置位置

**`ARG` 定义构建时的变量**，可用于控制构建过程（如版本号、源地址）。  
**最佳位置**：**尽早定义**，通常在 `FROM` 指令附近或依赖安装前。
 **示例 1：在 `FROM` 中使用 ARG**
```
 # 定义基础镜像版本参数（可通过 --build-arg 指定）
  ARG PYTHON_VERSION=3.11 
  FROM python:${PYTHON_VERSION}-slim 
  # 后续命令可继续使用该 ARG 
  ARG APP_ENV=production 
  RUN if [ "$APP_ENV" = "development" ]; then \
   apt-get install -y debug-tools; \
    fi
```
**示例 2：控制依赖安装**
```
ARG USE_CACHE=false

# 在依赖安装前使用 ARG
COPY requirements.txt .
RUN if [ "$USE_CACHE" = "true" ]; then \
        pip install --cache-dir /pip-cache -r requirements.txt; \
    else \
        pip install -r requirements.txt; \
    fi
```
####  **ENV（环境变量）的放置位置**
**`ENV` 定义容器运行时的环境变量**，会持久化到镜像中。  
**最佳位置**：**在需要使用这些变量的命令之前**，通常在依赖安装后、应用配置前。

```dockerfile
# 安装依赖（不依赖 ENV）
COPY requirements.txt .
RUN pip install -r requirements.txt

# 设置 ENV（影响后续命令和运行时）
ENV FLASK_APP=app.py \
    FLASK_ENV=production \
    PORT=8080

# 使用 ENV 的命令
EXPOSE $PORT
CMD ["flask", "run", "--host=0.0.0.0", "--port=$PORT"]
```
##### 关键规则
- **避免在频繁变更的 ARG 后放置不变的命令**
- **将不变的 ENV 放在靠近基础镜像的位置**




#### 2. 安装系统依赖（变更频率低）**

- 合并 `RUN` 命令减少层数
- 使用 `&&` 连接命令并清理缓存
- 避免安装不必要的包
```
RUN apt-get update && \ apt-get install -y --no-install-recommends \ python3-dev \ gcc \ && \ rm -rf /var/lib/apt/lists/* # 清理缓存减小镜像体积
```

### **3. 安装应用依赖（变更频率中等）**

- 先复制依赖清单文件（如 `requirements.txt`、`package.json`）
- 单独执行依赖安装命令
- 利用缓存避免重复安装相同依赖
```
# 1. 复制依赖清单 
COPY requirements.txt /app/ 
# 2. 安装依赖（这一层的缓存会在 requirements.txt 不变时复用） 
RUN pip install --no-cache-dir -r /app/requirements.txt
```

### **4. 复制应用代码（变更频率高）**

- 仅在代码变更时触发缓存失效
- 使用 `.dockerignore` 排除不必要的文件
```
COPY . /app/ # 放在依赖安装后，避免代码修改导致依赖重装
```

### **5. 配置环境变量和用户**

- 设置必要的环境变量
- 创建非 root 用户并设置权限
```
# 设置环境变量 
ENV PYTHONUNBUFFERED=1 \ PORT=8080 

# 创建非 root 用户 
RUN useradd -r -s /bin/sh appuser USER appuser
```

### **6. 定义运行时行为**
- 使用 `CMD` 或 `ENTRYPOINT` 定义启动命令
- 避免在 `CMD` 中执行复杂脚本
```
CMD ["python", "app.py"]
```