---
tags:
  - note
---
## 1. 核心观点  

Git 的 `.pack` 文件中保存的是压缩后的对象数据块，而 `.idx` 文件是对应的 **索引文件**，用于快速定位某个对象在 `.pack` 文件中的偏移量。

没有 `.idx`，Git 仍然能解析 `.pack`（通过顺序扫描），但：
- 性能极差；
- 无法快速按哈希（SHA-1 或 SHA-256）查找对象。
因此，`.idx` 相当于 `.pack` 的目录索引


## 2. 背景/出处  
- 来源：
- 引文/摘要：  
  - …  
  - …  

## 3. 展开说明  
与包文件一样，版本 2 索引文件以标头开头，尽管索引文件标头只有 8 个字节而不是 12 个字节。前四个字节始终是 `255、116、79、99`，选择这些字节是因为索引文件的第一个版本没有任何标头信息，而这四个字节将是版本 1 索引文件的无效启动。接下来的四个字节显式表示版本号——在我们的例子中，版本 2。

在标头之后，我们遇到了 Git 所说的扇出表。

该表中的**第一级条目是一系列 256 个条目，每个条目有 4 个字节，总共 1024 个字节长**。根据[文档](https://www.kernel.org/pub/software/scm/git/docs/v1.4.3/technical/pack-format.txt) ，“该表的第 N 个条目记录了相应包中的对象数，其对象名称的第一个字节小于或等于 N。
[Git-Parsing packfiles  扇出表](Git-Parsing%20packfiles%20%20扇出表.md)
![](asserts/Pasted%20image%2020251113153836.png)
让我们通过示例来分解它。请记住，对象名称只是 SHA，我们通常以 16 为基数读取。如果扇出表的第一个条目是 `4`，那么我们最终会找到四个 20 字节对象名称以 `00` 开头的对象。如果扇出表的第二个条目也是 `4`，这意味着我们将期望找到 20 字节对象名称为 `01` 的零个对象，因为这些总数是累积的，我们已经有四个名称以 `00` 开头的对象。如果第 17 个条目是第一个值大于 `4` 的条目，并且它的值为 `12`，那么这意味着我们将找到恰好八个名称以 `10` 开头的对象（请记住，对象名称使用以 16 为基数）。


此表有 256 个条目，因此最后一个条目告诉我们有多少对象的对象名称以 `ff` 或任何小于 `0xFF` 的单字节十六进制值开头。由于 `0xFF` （256） 是可以容纳到单个字节的最大值，因此最后一个条目告诉我们总共需要多少个对象。

扇出表的第二层按顺序包含 20 字节的对象名称。我们已经知道扇出表的第一层需要多少个。

扇出表的第三层为我们提供了每个对象的四字节循环[冗余校验](https://en.wikipedia.org/wiki/Cyclic_redundancy_check)值。请记住，包文件针对跨网络使用进行了优化，因此能够检查数据在传输过程中是否损坏非常重要。

第四层包含我们一直在寻找的信息：每个对象的 packfile 偏移量。每个条目也是四个字节。如果 packfile 小于 2 GB，则所有这些值的 MSB 将为 `0`，其余位包含 packfile 偏移量。否则，偏移量可能太大而无法容纳 4 个字节。在这种情况下，偏移量实际上将存储在第五层中，该对象的第四层中的 MSB 将为 `1`，其余位将是第五层中的偏移量，可以在该层中找到 packfile 的偏移量。

第五层也是最后一层仅适用于大于 2GB 的包文件。如果存在，它将包含一系列 8 字节条目，这些条目对包文件中的偏移量进行编码。如前所述，第四层将指示第五层中的哪些条目对应于每个对象 - 如果第四层中的元素设置了 MSB，则该元素中的其余位指定第五层中的哪个元素包含该对象的包文件偏移量。

这是扇出表的结尾。索引文件本身以 packfile 的 20 字节校验和和整个索引文件的 20 字节校验和结束。
### Searching packfiles  搜索包文件

在这一点上，您可能想知道为什么 Git 使用如此复杂的格式。虽然这种格式可能难以阅读，但它可以使用二分搜索来定位 IDX 文件中的特定对象。如果有多个包文件，则查找特定对象的唯一方法是搜索每个对象，因此二分搜索对于速度至关重要。此外，请记住，包文件（和 IDX 文件）是由网络性能驱动的。对于密集的包文件，包文件或索引文件中几乎没有冗余信息。信息不仅打包到每个字节中，而且打包到每个位中。

## 4. 与其他卡片的关联  
- 前置卡片：
- 后续卡片：
- 相似主题：

## 5. 应用/启发  
- 可以如何应用在工作、学习、生活中  
- 引发的思考与问题  

## 6. 待办/进一步探索  
- [ ] 深入阅读 xxx  
- [ ] 验证这个观点的边界条件  
