

## 1. 核心观点  
### Ⅰ. 概念层
**（引用增量对象），则对象元信息（我们之前已经解析过）之后是基础对象的 20 字节名称**。请记住，增量类似于差异，因此我们需要知道即将应用的差异的参考点是什么。在此名称之后，您**将看到 zlib 压缩的增量数据**，我们稍后会处理它。
- **格式结构：**
```rust
[type/size header] 
[20-byte base object name (SHA-1 or SHA-256)] 
[zlib-compressed delta data]
```
- **说明：**
    - 基对象通过其 **哈希值**（20 字节）来标识。
    - 优点：即使打包顺序改变，也能唯一定位基对象；
    - 缺点：每个引用都要存 20 字节 → 空间浪费。
> 示例：  
> 若某对象 A 的类型字段为 `OBJ_REF_DELTA`，则紧接着是一个 20 字节的哈希（base SHA），Git 用这个哈希查找对应基对象的偏移位置，然后用 zlib 解压 delta 并应用。


### Ⅱ. 实现层



### Ⅲ. 原理层

## 2. 背景/出处  
- 来源：
- 引文/摘要：  
  - …  
  - …  

## 3. 展开说明  

---
### 3.1 `[zlib-compressed delta data]`格式解析

- **增量对象（delta object）**：只存储与基对象（base object）的差异，而非完整对象内容。
- **组成结构**：
    1. **源长度**（source length）：基对象的大小
    2. **目标长度**（target length）：解压后对象的大小
    3. **指令序列**：描述如何从基对象生成目标对象
- **源长度和目标长度**：
    - 编码为 **可变长度整数（varint）**
    - MSB 用作继续标志（与标准 varint 类似）
    - 有助于解析错误检测，但并非严格必要

#### 3.1.1 源长度和目标长度
增量**以源长度和目标长度**开始，两者都编码为变长整数，这有助于错误检查，但并非必不可少。之后是一系列指令，可以是“复制”（MSB = 1）或“插入”（MSB = 0）。
#### 3.1.2 指令
##### 3.1.2.1 复制指令
 - **MSB = 1** → 表示这是复制指令
    - 功能：从基对象复制连续字节块到输出对象
    - 参数：
        1. **偏移量（offset）**：复制的起始位置
        2. **长度（size）**：要复制的字节数
    - 参数存储：**小端序可变长度整数**
    - 特点：
        - 支持压缩，未使用的字段可省略（默认为 0 或最大值）
        - 允许指令只指定部分偏移量或长度的字节，节省空间

复制指令指示我们**将源对象中的连续字节块复制到输出对象**。执行此操作需要两个数字：**要复制的第一个字节的位置（偏移量）和要复制的字节数**。这些数字在每条复制指令后都以_小端序_可变长度整数的形式存储；但是，它们的内容是压缩的。

```
+----------+---------+---------+---------+---------+-------+-------+-------+ | 1xxxxxxx | offset1 | offset2 | offset3 | offset4 | size1 | size2 | size3 | +----------+---------+---------+---------+---------+-------+-------+-------+
```
- **bit6~bit0（低 7 位）** 用作标志位，控制 offset/size 字节是否存在

| 位位置  | 含义           |
| ---- | ------------ |
| bit0 | offset1 是否存在 |
| bit1 | offset2 是否存在 |
| bit2 | offset3 是否存在 |
| bit3 | offset4 是否存在 |
| bit4 | size1 是否存在   |
| bit5 | size2 是否存在   |
| bit6 | size3 是否存在   |
标志字节 `10010001`（二进制）
```
bit7=1 → copy
bit6=0 → size3 不存在
bit5=0 → size2 不存在
bit4=1 → size1 存在
bit3=0 → offset4 不存在
bit2=0 → offset3 不存在
bit1=0 → offset2 不存在
bit0=1 → offset1 存在
```


###### 3.1.2.2 插入指令
**插入指令（insert）**：
- **MSB = 0** → 表示插入指令
- 功能：将 opcode 后跟的连续字节直接写入输出对象
- 参数：
	- 插入字节数隐含在 opcode 的低 7 位
	- 紧跟在 opcode 后的字节是需要插入的字节内容

### 3. 执行流程示意

假设 delta 流如下：

`[source length][target length][opcode1][param1][opcode2][param2]...`

- 解析 source/target length
- 循环解析每条 opcode：
    1. 如果 MSB=1 → copy
        - 读取偏移量和长度（小端序 varint）
        - 从基对象复制相应字节
    2. 如果 MSB=0 → insert
        - 直接将后续字节写入目标对象

最终输出 **完整目标对象**。

## 4. 与其他卡片的关联  
- 前置卡片：
- 后续卡片：
- 相似主题：

## 5. 应用/启发  
- 可以如何应用在工作、学习、生活中  
- 引发的思考与问题  

## 6. 待办/进一步探索  
- [ ] 深入阅读 xxx  
- [ ] 验证这个观点的边界条件  
